# Ease Grid — 基金盘中估值 + 低频网格交易

一个帮你**看基金实时涨跌**并**自动告诉你该买还是该卖**的本地工具。

不需要数据库，不需要云服务，跑在你自己电脑上，数据全部存本地文件。

---

## 目录

- [模块一：实时估值](#模块一实时估值)
- [模块二：低频网格策略](#模块二低频网格策略重点)
- [快速启动](#快速启动)
- [API 速查](#api-速查)

---

## 模块一：实时估值

**做什么：** 盘中交易时间，根据基金最新季报的持仓股票，乘以每只股票的实时涨跌幅，加权算出基金今天大概涨了多少或跌了多少。

**为什么需要：** 基金净值一天只公布一次（收盘后），但盘中你想知道大概情况，就靠这个估值。

### 估值怎么算的

```
估值涨跌 = Σ (每只持仓股的权重 × 该股今日涨跌幅)
```

举个例子：基金持仓 30% 茅台、20% 五粮液，茅台今天涨了 2%，五粮液跌了 1%：

```
估值涨跌 ≈ 30% × 2% + 20% × (-1%) = 0.4%
```

剩下 50% 仓位没有公开持仓数据的，用已知持仓的平均涨跌来补估。

### 置信度

每次估值会给一个 0~1 的置信度评分，告诉你这个估值有多靠谱：

- **覆盖率（占 70%）**：季报公开持仓能覆盖多少仓位。覆盖得越多越准。
- **时效性（占 30%）**：持仓数据是多久前的。30 天内满分，超过 180 天归零。

置信度低于 0.6 的时候，策略模块会自动变保守（比如不会在盘中触发补仓）。

### ETF 联接穿透

很多人买的是 ETF 联接基金（比如某某指数 C），它本身不直接持股，而是买了对应的 ETF。系统会自动检测这种情况，穿透到底层 ETF 的持仓来估值。也支持手动指定映射关系。

### 收盘后自动切换

下午 3:05 以后，估值数据不再可靠（尤其是含港股的基金），系统会自动切换为真实净值涨跌。

### 数据来源与缓存

| 数据 | 来源 | 缓存 |
|------|------|------|
| 持仓股票和权重 | 天天基金（季报） | 文件缓存，30 天有效 |
| 股票实时行情 | 新浪财经 | 内存缓存，8 秒刷新 |
| 基金真实净值 | 东方财富 | 内存缓存，1 小时 |

---

## 模块二：低频网格策略（重点）

**做什么：** 根据基金的实时估值、历史走势、你的持仓情况，自动计算出今天应该买、卖、还是不动，以及具体金额。

**核心思路：** 跌多了就买，涨多了就卖，控制节奏，别冲动。

这不是高频交易，也不是量化炒短线。它是给普通人做基金定投/网格的辅助决策工具——每天看一眼信号，照着操作就行。

### 策略信号类型一览

系统按优先级从高到低依次判断，触发第一个就停：

| 优先级 | 信号名 | 动作 | 什么时候触发 |
|--------|--------|------|-------------|
| 1 | 灾难保护 | 卖 | 持有不到 7 天就巨亏（≤-9%）或单日暴跌（≤-5%）— 紧急止损 |
| 2 | 止损（三级） | 卖 | 持有超 7 天且浮亏超过动态止损线 |
| 3 | 止盈 | 卖 | 浮盈达到目标，综合评分决定卖多少 |
| 4 | 大跌抄底 | 买 | 今日跌幅超过动态阈值（通常 -2% ~ -3%），且有预算 |
| 5 | 补仓 | 买 | 已有持仓且在亏损，满足补仓条件时加仓摊低成本 |
| 6 | 低位建仓 | 买 | 空仓状态，中期已经跌了不少，趁低位建仓 |
| 7 | 连跌低吸 / 冷却后建仓 | 买 | 连续下跌或卖出后冷却期结束 |
| 8 | 观望 | 不动 | 以上都没触发 |

### 止盈体系：统一评分，不靠拍脑袋

不是简单的"涨 5% 就卖"。每个持仓批次会算一个**止盈评分**（满分 100），由五个因子加权：

| 因子 | 满分 | 说明 |
|------|------|------|
| 盈利分 | 40 | 浮盈越高分越高，但边际递减（涨 10% 和涨 20% 差别没那么大） |
| 回撤分 | 30 | 从最高点回落越多越该卖（比如峰值浮盈 8% 现在只剩 5%） |
| 动量分 | 15 | 上涨动量在减弱时得分更高（趋势拐头信号） |
| 流动性分 | 15 | 当天大涨时额外加分（趁市场活跃多卖，冲击成本低） |
| 费率罚分 | 负分 | 持有天数太短、赎回费率高时扣分（避免为了小利付大费） |

评分结果：≥60 全卖，≥45 卖七成，≥30 卖一半，≥20 卖三成。

### 止损体系：三级递进，不一刀切

| 级别 | 条件 | 动作 |
|------|------|------|
| L1 预警 | 浮亏接近止损线（70%） | 只标记，不操作 |
| L2 常规止损 | 浮亏触达止损线 | 卖出 50%，保留反弹仓位 |
| L3 极端止损 | 浮亏超止损线 1.5 倍，或连跌 ≥5 天 | 全部清仓 |

止损线不是固定数字，它会根据基金的波动率和最大回撤动态调整。波动大的基金止损线更宽，波动小的更窄。

### 补仓逻辑：看效率，不是盲目加仓

补仓的核心问题是：**这次加仓能让我的平均成本降多少？** 系统会计算"成本修复效率"：

```
成本修复效率 = 补仓后均价下降幅度 / 补仓金额
```

效率太低的补仓不做（比如已经补了很多次，再补一点对均价影响微乎其微）。

补仓还有这些限制：

- **次数上限**：动态计算，大仓位基金最多 5 次，小仓位 2~3 次
- **节奏阀**：两次补仓之间至少间隔 3 个交易日，且价格要比上次补仓再跌一定幅度
- **禁入条件**：10 日累跌超 -7% 且连跌 3 天、或波动率极端、或估值置信度太低时，暂停补仓

### 波动率状态机：不同市况用不同参数

系统把波动率分成四档，自动调整所有买卖阈值：

| 状态 | 波动率范围 | 策略行为 |
|------|-----------|---------|
| 低波动 | < 0.8% | 收窄网格，买卖都更灵敏 |
| 正常 | 0.8% ~ 1.8% | 标准参数 |
| 高波动 | 1.8% ~ 3.0% | 放宽网格，不轻易出手 |
| 极端波动 | > 3.0% | 暂停所有买入，只允许止损 |

### 组合级风控：不把鸡蛋放一个篮子

当你同时管多只基金时，系统会在组合层面做额外控制：

- **每日买入上限**：普跌时只用总额度的 4%（省子弹），普涨时放宽到 8%
- **同赛道集中度**：同一板块内的基金，单日买入总额不超过有效预算的 40%
- **多只同时触发时打折**：2 只基金同时要买，每只打 85 折；3 只打 70 折；以此类推，最低 65 折

### 冷却期

卖出后进入冷却期（2 个交易日），期间不会触发新的买入信号。冷却结束后，如果当天不涨，会自动给出重新建仓信号。

### 持仓管理

- 按批次记录每笔买入（金额、净值、日期、份额）
- 支持 FIFO 卖出（模拟支付宝的先进先出）
- 支持同一基金多人持仓（比如"017193__老婆"和"017193__老公"分开记账）
- 每只基金可单独设置赎回费率表
- 所有数据存在本地 `data/positions.json`

### 信号历史与回测

每天的信号会记录到 `data/signal_history.json`，包括触发时的净值。收盘后会回填 T+3、T+5、T+10 的实际涨跌，用来计算：

- 买入信号胜率（T+5 赚钱的比例）
- 卖出信号准确率（T+5 继续跌的比例）

如果最近 30 天买入信号胜率低于 40%，系统会自动收紧买入阈值 10%。

---

## 快速启动

```bash
pip install fastapi uvicorn pydantic
python app.py
```

服务跑在 `http://localhost:8000`，用 `demo.html` 打开前端界面。

---

## API 速查

### 估值

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/v1/valuation/{fund_code}` | 单基金估值 |
| POST | `/v1/valuation/batch` | 批量估值（上限 500） |
| GET | `/v1/valuation/state` | 按板块分组估值 |

### 策略信号

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/v1/strategy/signals` | 全部基金策略信号 |
| GET | `/v1/strategy/signal/{fund_code}` | 单基金信号 |
| GET | `/v1/strategy/history` | 信号历史 |

### 持仓管理

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/v1/positions` | 全部持仓 |
| POST | `/v1/position/{code}/buy` | 买入 |
| POST | `/v1/position/{code}/sell` | 按批次卖出 |
| POST | `/v1/position/{code}/sell-fifo` | FIFO 卖出 |

### 其他

| 方法 | 路径 | 说明 |
|------|------|------|
| GET/POST | `/v1/state` | 自选板块管理 |
| POST | `/v1/etf-link` | ETF 联接映射 |
| POST | `/v1/holdings/refresh` | 刷新持仓缓存 |
| GET | `/health` | 健康检查 |

---

## 文件结构

```
├── app.py            # API 入口（FastAPI）
├── core.py           # 估值计算引擎
├── providers.py      # 数据抓取 + 缓存（天天基金/新浪/东方财富）
├── strategy.py       # 低频网格策略信号引擎（v5.0）
├── positions.py      # 持仓记录管理
├── demo.html         # 前端界面
├── data/
│   ├── state.json           # 板块和基金列表
│   ├── positions.json       # 持仓记录
│   └── signal_history.json  # 信号历史
└── cache/
    └── holdings_*.json      # 持仓缓存（30 天有效）
```