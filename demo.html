<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶ä¼°å€¼ Â· ä½é¢‘ç½‘æ ¼å·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
            background: #f0f2f5;
            color: #1a1a2e;
            min-height: 100vh;
            font-size: 13px;
        }
        .container { max-width: 960px; margin: 0 auto; padding: 12px; }
        h1 {
            text-align: center;
            margin-bottom: 12px;
            color: #1a1a2e;
            font-size: 18px;
            font-weight: 600;
        }

        /* é¡¶éƒ¨æ“ä½œæ  */
        .toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            align-items: center;
        }
        .toolbar button {
            padding: 6px 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all .15s;
        }
        .btn-primary { background: #4f46e5; color: #fff; }
        .btn-primary:hover { background: #4338ca; }
        .btn-primary:disabled { background: #a5b4fc; cursor: not-allowed; }
        .btn-success { background: #10b981; color: #fff; }
        .btn-success:hover { background: #059669; }
        .btn-warning { background: #f59e0b; color: #fff; }
        .btn-warning:hover { background: #d97706; }
        .btn-danger { background: #ef4444; color: #fff; }
        .btn-danger:hover { background: #dc2626; }

        .refresh-status {
            margin-left: auto;
            font-size: 11px;
            color: #6b7280;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .refresh-status .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* çŠ¶æ€æç¤º */
        .status {
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 12px;
            display: none;
        }
        .status.show { display: block; }
        .status.success { background: #d1fae5; color: #065f46; }
        .status.error { background: #fee2e2; color: #991b1b; }
        .status.info { background: #dbeafe; color: #1e40af; }

        /* Tab åˆ‡æ¢ */
        .tab-bar {
            display: flex;
            gap: 0;
            margin-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
        }
        .tab-btn {
            padding: 8px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all .15s;
        }
        .tab-btn.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
        }
        .tab-btn:hover { color: #4338ca; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* æ¿å— */
        .sector {
            background: #fff;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,.08);
            overflow: hidden;
        }
        .sector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
        }
        .sector-name {
            font-weight: 600;
            font-size: 14px;
            color: #1e293b;
        }
        .btn-export {
            background: none;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            color: #6b7280;
            transition: all .15s;
        }
        .btn-export:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }

        /* ç´§å‡‘è¡¨æ ¼ */
        .fund-table {
            width: 100%;
            border-collapse: collapse;
        }
        .fund-table th {
            background: #f1f5f9;
            padding: 6px 10px;
            text-align: left;
            font-weight: 500;
            font-size: 11px;
            color: #64748b;
            border-bottom: 1px solid #e2e8f0;
        }
        .fund-table td {
            padding: 6px 10px;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
        }
        .fund-table tr:last-child td { border-bottom: none; }
        .fund-table tr:hover { background: #f8fafc; }

        .td-code {
            font-family: "SF Mono", Monaco, monospace;
            font-weight: 600;
            color: #4f46e5;
            font-size: 12px;
            width: 70px;
            cursor: pointer;
        }
        .td-code:hover { text-decoration: underline; }
        .td-name {
            color: #374151;
            font-size: 12px;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .td-change {
            font-weight: 700;
            font-size: 14px;
            text-align: right;
            width: 90px;
            white-space: nowrap;
        }
        .td-change.up { color: #dc2626; }
        .td-change.down { color: #16a34a; }
        .td-change.flat { color: #6b7280; }

        .td-confidence {
            font-size: 11px;
            color: #9ca3af;
            text-align: right;
            width: 60px;
        }
        .td-action {
            width: 60px;
            text-align: center;
        }
        .td-action button {
            background: none;
            border: none;
            color: #d1d5db;
            cursor: pointer;
            font-size: 14px;
            padding: 2px 6px;
            border-radius: 4px;
        }
        .td-action button:hover {
            color: #ef4444;
            background: #fef2f2;
        }

        /* æ·»åŠ è¡¨å• */
        .add-row {
            display: flex;
            gap: 8px;
            padding: 8px 10px;
            background: #fafafa;
            border-top: 1px solid #f1f5f9;
        }
        .add-row input {
            padding: 6px 10px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            font-size: 12px;
            outline: none;
            transition: border-color .15s;
        }
        .add-row input:focus { border-color: #4f46e5; }
        .add-row input[name="code"] { width: 80px; }
        .add-row input[name="alias"] { flex: 1; min-width: 0; }
        .add-row button {
            padding: 6px 12px;
            font-size: 12px;
            white-space: nowrap;
        }

        /* å¼¹çª— */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,.4);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 360px;
        }
        .modal-content.wide {
            max-width: 520px;
        }
        .modal-content h3 { margin-bottom: 12px; font-size: 15px; }
        .modal-content input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 12px;
        }
        .modal-actions { display: flex; gap: 8px; justify-content: flex-end; }
        .modal-actions button { padding: 8px 16px; font-size: 13px; border-radius: 6px; }
        .btn-secondary { background: #e5e7eb; color: #374151; border: none; cursor: pointer; }
        .btn-secondary:hover { background: #d1d5db; }

        /* ç©ºçŠ¶æ€ */
        .empty { text-align: center; padding: 40px 20px; color: #9ca3af; }
        .empty-icon { font-size: 36px; margin-bottom: 10px; }

        /* åŠ è½½ */
        .loading {
            display: inline-block;
            width: 12px; height: 12px;
            border: 2px solid #e5e7eb;
            border-top-color: #4f46e5;
            border-radius: 50%;
            animation: spin .6s linear infinite;
            margin-right: 6px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* æ›´æ–°æ—¶é—´ */
        .update-time {
            text-align: center;
            color: #9ca3af;
            font-size: 11px;
            margin-top: 12px;
        }

        /* ========== å‡€å€¼å†å²å¼¹çª— ========== */
        .nav-history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            margin-top: 8px;
        }
        .nav-history-table th {
            background: #f1f5f9;
            padding: 5px 8px;
            text-align: left;
            font-weight: 500;
            color: #64748b;
            font-size: 11px;
        }
        .nav-history-table td {
            padding: 4px 8px;
            border-bottom: 1px solid #f1f5f9;
        }
        .nav-history-table .up { color: #dc2626; font-weight: 600; }
        .nav-history-table .down { color: #16a34a; font-weight: 600; }
        .nav-history-table .flat { color: #6b7280; }
        .nav-history-scroll {
            max-height: 400px;
            overflow-y: auto;
        }
        /* è¿·ä½ æŸ±çŠ¶å›¾ */
        .mini-bar {
            display: inline-block;
            height: 10px;
            min-width: 1px;
            border-radius: 1px;
            vertical-align: middle;
            margin-left: 4px;
        }

        /* ========== ç­–ç•¥é¢æ¿ ========== */
        .strategy-panel { margin-top: 4px; }

        /* ========== v5.17: è¡Œæƒ…æ¨¡å¼ï¼ˆç´§å‡‘å†…è”ï¼‰ ========== */
        .regime-inline { display: inline-flex; align-items: center; gap: 4px; margin: 0 8px; }
        .regime-inline .ri-btn {
            padding: 2px 8px; border: 1.5px solid #e2e8f0; border-radius: 4px;
            background: #fff; cursor: pointer; font-size: 11px; transition: .15s;
        }
        .regime-inline .ri-btn:hover { border-color: #94a3b8; }
        .regime-inline .ri-btn.active-neutral { border-color: #6366f1; background: #eef2ff; color: #4f46e5; font-weight: 600; }
        .regime-inline .ri-btn.active-bear { border-color: #10b981; background: #ecfdf5; color: #059669; font-weight: 600; }
        .regime-auto-badge {
            font-size: 10px; padding: 1px 6px; border-radius: 3px;
            background: #e0e7ff; color: #4338ca; font-weight: 500; cursor: pointer;
        }
        .regime-auto-badge.manual { background: #fef3c7; color: #92400e; }
        .fitness-badge {
            display: inline-block; font-size: 10px; padding: 1px 5px;
            border-radius: 3px; font-weight: 600; margin-left: 4px;
        }
        .fitness-badge.grade-A { background: #d1fae5; color: #059669; }
        .fitness-badge.grade-B { background: #dbeafe; color: #2563eb; }
        .fitness-badge.grade-C { background: #fef3c7; color: #d97706; }
        .fitness-badge.grade-D { background: #fed7aa; color: #ea580c; }
        .fitness-badge.grade-E { background: #fecaca; color: #dc2626; }

        .signal-card {
            background: #fff;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,.08);
            overflow: hidden;
        }
        .signal-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
        }
        .signal-card-header .fund-info {
            font-weight: 600;
            font-size: 13px;
            color: #1e293b;
        }
        .signal-card-header .fund-info .code {
            font-family: "SF Mono", Monaco, monospace;
            color: #4f46e5;
            cursor: pointer;
        }
        .signal-card-header .fund-info .code:hover { text-decoration: underline; }

        .signal-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .signal-badge.sell { background: #fee2e2; color: #dc2626; }
        .signal-badge.buy { background: #d1fae5; color: #059669; }
        .signal-badge.hold { background: #f3f4f6; color: #6b7280; }
        .signal-badge.alert { background: #fef3c7; color: #d97706; }

        .signal-card-body {
            padding: 10px 14px 6px;
        }
        .signal-reason {
            font-size: 12px;
            color: #374151;
            margin-bottom: 4px;
            line-height: 1.5;
        }
        .signal-fee {
            font-size: 11px;
            color: #6b7280;
            margin-bottom: 4px;
        }
        .signal-alert {
            background: #fef3c7;
            border-radius: 4px;
            padding: 4px 10px;
            font-size: 11px;
            color: #92400e;
            margin-bottom: 4px;
        }

        .pos-summary {
            display: flex;
            flex-wrap: wrap;
            font-size: 11px;
            color: #6b7280;
            padding: 6px 14px;
            background: #fafbfc;
            border-top: 1px solid #f1f5f9;
            justify-content: space-between;
        }
        .pos-summary .item { display: flex; gap: 4px; }
        .pos-summary .label { color: #9ca3af; }
        .pos-summary .value { font-weight: 600; color: #374151; }

        .pos-batches {
            padding: 0 14px 6px;
            overflow-x: auto;
        }
        .pos-batches table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            table-layout: fixed;
        }
        .pos-batches th {
            text-align: left;
            padding: 4px 6px;
            color: #9ca3af;
            font-weight: 500;
            font-size: 10px;
        }
        .pos-batches td {
            padding: 4px 6px;
            border-top: 1px solid #f5f5f5;
            color: #374151;
        }
        .pos-actions {
            padding: 6px 14px;
            border-top: 1px solid #f1f5f9;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .pos-actions button {
            padding: 5px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 5px;
            background: #fff;
            cursor: pointer;
            font-size: 11px;
            transition: all .15s;
        }
        .pos-actions button:hover { background: #f3f4f6; }
        .pos-actions .buy-btn { border-color: #10b981; color: #059669; }
        .pos-actions .buy-btn:hover { background: #ecfdf5; }
        .pos-actions .sell-btn { border-color: #ef4444; color: #dc2626; }
        .pos-actions .sell-btn:hover { background: #fef2f2; }

        /* è¡Œæƒ…åˆ†æåŒºåŸŸ */
        .market-analysis {
            padding: 4px 14px 2px;
            border-top: 1px solid #f1f5f9;
        }
        .market-analysis .trend-bar {
            display: flex;
            gap: 1px;
            align-items: stretch;
            margin-bottom: 2px;
            position: relative;
        }
        .market-analysis .trend-bar .day-bar {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .market-analysis .trend-bar .day-bar .bar-upper {
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            width: 100%;
        }
        .market-analysis .trend-bar .day-bar .bar-lower {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            width: 100%;
        }
        .market-analysis .trend-bar .day-bar .bar-fill {
            width: 80%;
            border-radius: 1px;
            min-height: 0;
        }
        .market-analysis .trend-bar .day-bar .bar-label {
            font-size: 7px;
            color: #9ca3af;
            white-space: nowrap;
            line-height: 1.1;
            margin-top: 1px;
        }
        .market-analysis .trend-bar .day-bar .bar-value {
            font-size: 8px;
            font-weight: 600;
            white-space: nowrap;
            line-height: 1.1;
        }
        .market-analysis .zero-line {
            width: 100%;
            height: 1px;
            background: #e5e7eb;
            margin: 0;
        }
        .market-stats {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            font-size: 10px;
            color: #6b7280;
            padding: 4px 0 4px;
            justify-content: space-between;
        }
        .market-stats .stat-item {
            display: flex;
            gap: 3px;
        }
        .market-stats .stat-label { color: #9ca3af; }
        .market-stats .stat-value { font-weight: 600; }
        .market-stats .stat-value.up { color: #dc2626; }
        .market-stats .stat-value.down { color: #059669; }
        .market-stats .stat-value.flat { color: #6b7280; }

        /* ç­–ç•¥è¯´æ˜æç¤º */
        .strategy-info-btn {
            background: none;
            border: 1px solid #e5e7eb;
            color: #9ca3af;
            font-size: 10px;
            cursor: pointer;
            padding: 1px 6px;
            border-radius: 3px;
            margin-left: 4px;
        }
        .strategy-info-btn:hover { background: #f3f4f6; color: #374151; }
        .strategy-info-box {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 6px 10px;
            margin: 4px 0 6px;
            font-size: 10px;
            color: #6b7280;
            line-height: 1.6;
            display: none;
        }
        .strategy-info-box.show { display: block; }

        /* ä¹°å…¥/å–å‡ºå¼¹çª— form */
        .trade-form { display: flex; flex-direction: column; gap: 10px; }
        .trade-form label { font-size: 12px; color: #374151; font-weight: 500; }
        .trade-form input, .trade-form select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 13px;
            margin-top: 2px;
        }
        .trade-form .hint { font-size: 11px; color: #9ca3af; margin-top: 2px; }

        /* ç­–ç•¥åˆ†ç»„ */
        .strategy-group {
            background: #fff;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,.08);
            overflow: hidden;
        }
        .strategy-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
        }
        .strategy-group-header .group-name {
            font-weight: 600;
            font-size: 14px;
            color: #1e293b;
            cursor: pointer;
        }
        .strategy-group-header .group-name:hover { color: #4f46e5; }
        .strategy-group-header .group-actions {
            display: flex;
            gap: 4px;
        }
        .strategy-group-header .group-actions button {
            background: none;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 3px 7px;
            cursor: pointer;
            font-size: 11px;
            color: #6b7280;
            transition: all .15s;
        }
        .strategy-group-header .group-actions button:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }
        .strategy-group-body { padding: 0; }
        .ungrouped-label {
            font-size: 12px;
            color: #9ca3af;
            padding: 8px 14px 4px;
        }

        /* æ— æŒä»“åŸºé‡‘å¿«é€Ÿæ·»åŠ  */
        .add-position-bar {
            background: #fff;
            border-radius: 8px;
            padding: 12px 14px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,.08);
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .add-position-bar input {
            padding: 6px 10px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            font-size: 12px;
            outline: none;
            width: 90px;
        }
        .add-position-bar input:focus { border-color: #4f46e5; }
        .add-position-bar span { font-size: 12px; color: #6b7280; }
    </style>
</head>
<body>
    <div class="container">

        <div class="toolbar">
            <div class="refresh-status">
                <span class="dot"></span>
                <span id="refreshTimer">è‡ªåŠ¨åˆ·æ–°ä¸­</span>
            </div>
        </div>

        <div class="status" id="status"></div>

        <!-- Tab åˆ‡æ¢ -->
        <div class="tab-bar">
            <button class="tab-btn active" onclick="switchTab('valuation')">å®æ—¶ä¼°å€¼</button>
            <button class="tab-btn" onclick="switchTab('strategy')">ä½é¢‘ç½‘æ ¼</button>
        </div>

        <!-- ä¼°å€¼çœ‹æ¿ -->
        <div class="tab-panel active" id="tab-valuation">
            <div style="display:flex;gap:8px;margin-bottom:10px;">
                <button class="btn-primary" onclick="refreshAll()" id="refreshBtn">ğŸ”„ åˆ·æ–°</button>
                <button class="btn-success" onclick="showAddSectorModal()">â• æ–°å»ºæ¿å—</button>
                <button class="btn-warning" onclick="exportAllSectorImages()">ğŸ“· æ‰¹é‡å¯¼å‡º</button>
            </div>
            <div id="sectors"></div>
        </div>

        <!-- ç­–ç•¥é¢æ¿ -->
        <div class="tab-panel" id="tab-strategy">
            <div class="strategy-panel" id="strategyPanel">
                <div class="empty">
                    <div class="empty-icon">ğŸ“¡</div>
                    <p>ç‚¹å‡»"åˆ·æ–°ä¿¡å·"è·å–ç­–ç•¥å»ºè®®</p>
                </div>
            </div>
        </div>

        <div class="update-time" id="updateTime"></div>
    </div>

    <!-- æ–°å»ºæ¿å—å¼¹çª— -->
    <div class="modal" id="addSectorModal">
        <div class="modal-content">
            <h3>æ–°å»ºæ¿å—</h3>
            <input type="text" id="newSectorName" placeholder="è¾“å…¥æ¿å—åç§°ï¼Œå¦‚ï¼šæœ‰è‰²é‡‘å±">
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeModal('addSectorModal')">å–æ¶ˆ</button>
                <button class="btn-primary" onclick="addSector()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- ETFæ˜ å°„å¼¹çª— -->
    <div class="modal" id="etfLinkModal">
        <div class="modal-content">
            <h3>è®¾ç½®ETFè”æ¥ç©¿é€</h3>
            <p style="font-size:12px;color:#666;margin-bottom:12px;">
                å¯¹äºETFè”æ¥åŸºé‡‘ï¼Œå¯æŒ‡å®šç›®æ ‡ETFä»¥è·å–å‡†ç¡®æŒä»“
            </p>
            <input type="text" id="etfLinkCode" placeholder="è”æ¥åŸºé‡‘ä»£ç ï¼ˆå¦‚016708ï¼‰" maxlength="6" readonly>
            <input type="text" id="etfTargetCode" placeholder="ç›®æ ‡ETFä»£ç ï¼ˆå¦‚516650ï¼‰" maxlength="6">
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeModal('etfLinkModal')">å–æ¶ˆ</button>
                <button class="btn-secondary" onclick="clearEtfLink()" style="color:#ef4444;">æ¸…é™¤æ˜ å°„</button>
                <button class="btn-primary" onclick="saveEtfLink()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- å‡€å€¼å†å²å¼¹çª— -->
    <div class="modal" id="navHistoryModal">
        <div class="modal-content wide">
            <h3 id="navHistoryTitle">å‡€å€¼å†å²</h3>
            <div class="nav-history-scroll" id="navHistoryBody">
                <p style="text-align:center;color:#9ca3af;padding:20px;">åŠ è½½ä¸­...</p>
            </div>
            <div class="modal-actions" style="margin-top:12px;">
                <button class="btn-secondary" onclick="closeModal('navHistoryModal')">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- ä¹°å…¥å¼¹çª— -->
    <div class="modal" id="buyModal">
        <div class="modal-content">
            <h3 id="buyModalTitle">å½•å…¥ä¹°å…¥</h3>
            <div class="trade-form">
                <div>
                    <label>ä¹°å…¥æ—¥æœŸ</label>
                    <input type="date" id="buyDate">
                    <div class="hint">ä¸‹å•æ—¥æœŸï¼ˆå½±å“æŒæœ‰å¤©æ•°å’Œè´¹ç‡è®¡ç®—ï¼‰</div>
                </div>
                <div>
                    <label>ä¹°å…¥é‡‘é¢ï¼ˆå…ƒï¼‰</label>
                    <input type="number" id="buyAmount" placeholder="æ”¯ä»˜å®æ˜¾ç¤ºçš„ä¹°å…¥é‡‘é¢" step="100">
                </div>
                <div>
                    <label>ç¡®è®¤å‡€å€¼</label>
                    <input type="number" id="buyNav" placeholder="ä»½é¢ç¡®è®¤é¡µæ˜¾ç¤ºçš„å‡€å€¼" step="0.0001">
                    <div class="hint" id="buyNavHint">åœ¨æ”¯ä»˜å®â†’æŒä»“â†’äº¤æ˜“è®°å½•ä¸­æŸ¥çœ‹ã€Œç¡®è®¤å‡€å€¼ã€</div>
                </div>
                <div>
                    <label>å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="buyNote" placeholder="æ–¹ä¾¿è‡ªå·±å›å¿†ï¼Œå¦‚ï¼šå¤§è·ŒæŠ„åº•ã€è¡¥ä»“ã€å®šæŠ•">
                </div>
                <div style="display:flex;align-items:center;gap:8px;">
                    <input type="checkbox" id="buySupplement" style="width:auto;margin:0;">
                    <label for="buySupplement" style="font-weight:400;color:#6b7280;font-size:12px;">è¡¥ä»“ä¹°å…¥ï¼ˆè®¡å…¥è¡¥ä»“æ¬¡æ•°ï¼Œå¤‡æ³¨ä»¥"è¡¥ä»“"å¼€å¤´ä¹Ÿä¼šè‡ªåŠ¨è¯†åˆ«ï¼‰</label>
                </div>
            </div>
            <input type="hidden" id="buyFundCode">
            <input type="hidden" id="buyOwner">
            <div class="modal-actions" style="margin-top:12px;">
                <button class="btn-secondary" onclick="closeModal('buyModal')">å–æ¶ˆ</button>
                <button class="btn-success" onclick="submitBuy()">ç¡®è®¤å½•å…¥</button>
            </div>
        </div>
    </div>

    <!-- å–å‡ºå¼¹çª— -->
    <div class="modal" id="sellModal">
        <div class="modal-content">
            <h3 id="sellModalTitle">å½•å…¥å–å‡º</h3>
            <div class="trade-form">
                <div>
                    <label>å–å‡ºæ—¥æœŸ</label>
                    <input type="date" id="sellDate">
                    <div class="hint">ä¸‹å•æ—¥æœŸï¼ˆå½±å“æŒæœ‰å¤©æ•°å’Œè´¹ç‡è®¡ç®—ï¼‰</div>
                </div>
                <div id="sellBatchSelectWrap">
                    <label>å–å‡ºæ‰¹æ¬¡</label>
                    <select id="sellBatchSelect" onchange="onSellBatchChange()">
                        <option value="">è¯·é€‰æ‹©...</option>
                    </select>
                    <div class="hint" id="sellBatchHint"></div>
                </div>
                <div id="sellFifoInfo" style="display:none;">
                    <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:6px;padding:8px 10px;font-size:11px;color:#1e40af;">
                        <b>FIFO æ¨¡å¼</b>ï¼šæ”¯ä»˜å®æŒ‰å…ˆè¿›å…ˆå‡ºè‡ªåŠ¨æ‰£å‡ä»½é¢ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æŒ‰ FIFO é¡ºåºæ‹†åˆ†åˆ°å„æ‰¹æ¬¡ã€‚
                        <div id="sellFifoSteps" style="margin-top:4px;"></div>
                    </div>
                </div>
                <div>
                    <label>å–å‡ºä»½é¢</label>
                    <input type="number" id="sellShares" placeholder="æ”¯ä»˜å®â†’äº¤æ˜“è®°å½•ä¸­çš„ã€Œå–å‡ºä»½é¢ã€" step="0.01">
                    <div class="hint" id="sellSharesHint"></div>
                </div>
                <div>
                    <label>ç¡®è®¤å‡€å€¼ï¼ˆé€‰å¡«ï¼‰</label>
                    <input type="number" id="sellNav" placeholder="é‡‘é¢ç¡®è®¤åè¡¥å½•ï¼Œå¯å…ˆç•™ç©º" step="0.0001">
                    <div class="hint">å–å‡ºé‡‘é¢ç¡®è®¤åï¼Œåœ¨äº¤æ˜“è®°å½•ä¸­æŸ¥çœ‹ç¡®è®¤å‡€å€¼</div>
                </div>
            </div>
            <input type="hidden" id="sellFundCode">
            <input type="hidden" id="sellMode" value="batch">
            <div class="modal-actions" style="margin-top:12px;">
                <button class="btn-secondary" onclick="closeModal('sellModal')">å–æ¶ˆ</button>
                <button class="btn-danger" onclick="submitSell()">ç¡®è®¤å–å‡º</button>
            </div>
        </div>
    </div>

    <!-- åˆ†ç»„ç®¡ç†å¼¹çª— -->
    <div class="modal" id="groupModal">
        <div class="modal-content">
            <h3 id="groupModalTitle">æ–°å»ºåˆ†ç»„</h3>
            <input type="text" id="groupNameInput" placeholder="è¾“å…¥åˆ†ç»„åç§°ï¼Œå¦‚ï¼šæœ‰è‰²é‡‘å±">
            <input type="hidden" id="groupEditId" value="">
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeModal('groupModal')">å–æ¶ˆ</button>
                <button class="btn-primary" onclick="saveGroup()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- åˆ†é…åŸºé‡‘åˆ°åˆ†ç»„å¼¹çª— -->
    <div class="modal" id="assignGroupModal">
        <div class="modal-content">
            <h3 id="assignGroupTitle">åˆ†é…åˆ°åˆ†ç»„</h3>
            <div id="assignGroupList" style="max-height:300px;overflow-y:auto;"></div>
            <div class="modal-actions" style="margin-top:12px;">
                <button class="btn-secondary" onclick="closeModal('assignGroupModal')">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- æ–°å¢æ¨¡å—å¼¹çª—ï¼ˆåŒåŸºé‡‘å¤šäººæŒä»“ï¼‰ -->
    <div class="modal" id="addInstanceModal">
        <div class="modal-content">
            <h3>æ–°å¢æŒä»“æ¨¡å—</h3>
            <p style="font-size:11px;color:#6b7280;margin-bottom:12px;">
                åŒä¸€åŸºé‡‘å¯ä¸ºä¸åŒäººå„è‡ªå»ºç«‹ç‹¬ç«‹çš„æŒä»“å’Œç­–ç•¥è·Ÿè¸ªï¼Œ<br>
                ä¾‹å¦‚ä¸º"è€å…¬"å’Œ"è€å©†"åˆ†åˆ«è·Ÿè¸ª 017193ã€‚
            </p>
            <div class="trade-form">
                <div>
                    <label>åŸºé‡‘ä»£ç </label>
                    <input type="text" id="instanceFundCode" placeholder="6ä½åŸºé‡‘ä»£ç " maxlength="6">
                </div>
                <div>
                    <label>æŒä»“äºº/æ ‡ç­¾</label>
                    <input type="text" id="instanceOwner" placeholder="å¦‚ï¼šè€å…¬ã€è€å©†ã€è´¦æˆ·A" maxlength="10">
                    <div class="hint">ç”¨äºåŒºåˆ†åŒåŸºé‡‘ä¸åŒäººçš„æŒä»“</div>
                </div>
            </div>
            <div class="modal-actions" style="margin-top:12px;">
                <button class="btn-secondary" onclick="closeModal('addInstanceModal')">å–æ¶ˆ</button>
                <button class="btn-warning" onclick="submitAddInstance()">åˆ›å»ºå¹¶å½•å…¥ä¹°å…¥</button>
            </div>
        </div>
    </div>

    <!-- çµæ•åº¦è°ƒæ•´å¼¹çª— -->
    <div class="modal" id="volSensModal">
        <div class="modal-content">
            <h3 id="volSensTitle">è°ƒæ•´æ³¢åŠ¨ç‡çµæ•åº¦</h3>
            <p style="font-size:11px;color:#6b7280;margin-bottom:8px;">
                çµæ•åº¦å½±å“ä¹°å–é˜ˆå€¼çš„å®½çª„ï¼š<b>&gt;1.0</b> é˜ˆå€¼æ›´å®½ï¼ˆæ›´ä¸å®¹æ˜“è§¦å‘ï¼‰ï¼Œ<b>&lt;1.0</b> é˜ˆå€¼æ›´çª„ï¼ˆæ›´çµæ•ï¼‰ã€‚
            </p>
            <div id="volSensInfo" style="font-size:11px;color:#6b7280;margin-bottom:8px;padding:6px 8px;background:#f8fafc;border-radius:4px;"></div>
            <div class="trade-form">
                <div>
                    <label>çµæ•åº¦å€¼ (0.5 ~ 1.5)</label>
                    <input type="range" id="volSensSlider" min="0.5" max="1.5" step="0.05" value="1.0"
                           oninput="document.getElementById('volSensDisplay').textContent=this.value"
                           style="width:100%;margin-top:4px;">
                    <div style="display:flex;justify-content:space-between;font-size:10px;color:#9ca3af;">
                        <span>0.5 çµæ•</span>
                        <span id="volSensDisplay" style="font-weight:600;color:#4f46e5;font-size:13px;">1.00</span>
                        <span>1.5 è¿Ÿé’</span>
                    </div>
                </div>
            </div>
            <input type="hidden" id="volSensFundCode">
            <div class="modal-actions" style="margin-top:12px;">
                <button class="btn-secondary" onclick="closeModal('volSensModal')">å–æ¶ˆ</button>
                <button class="btn-secondary" onclick="clearVolSensitivity()" style="color:#f59e0b;">æ¢å¤è‡ªåŠ¨</button>
                <button class="btn-secondary" onclick="recalibrateVolSensitivity()" style="color:#4f46e5;">é‡æ–°æ ¡å‡†</button>
                <button class="btn-primary" onclick="saveVolSensitivity()">æ‰‹åŠ¨è®¾ç½®</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let state = { version: 1, sectors: [] };
        let valuations = {};
        let autoRefreshTimer = null;
        let isRefreshing = false;
        let lastRefreshTime = null;
        let currentTab = 'valuation';

        // ============ çŠ¶æ€æç¤º ============
        function showStatus(msg, type = 'info') {
            const el = document.getElementById('status');
            el.textContent = msg;
            el.className = `status show ${type}`;
            setTimeout(() => el.classList.remove('show'), 2500);
        }

        // ============ Tab åˆ‡æ¢ ============
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            document.querySelector(`.tab-btn[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');

            if (tab === 'strategy') {
                loadRegimeStatus();
                loadStrategyPanel();
            }
        }

        // ============ å¼¹çª—æ§åˆ¶ ============
        function showAddSectorModal() {
            document.getElementById('newSectorName').value = '';
            document.getElementById('addSectorModal').classList.add('show');
            document.getElementById('newSectorName').focus();
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        // ============ API è°ƒç”¨ ============
        async function loadState() {
            try {
                const res = await fetch(`${API_BASE}/v1/state`);
                state = await res.json();
                render();
            } catch (e) {
                showStatus('åŠ è½½å¤±è´¥: ' + e.message, 'error');
            }
        }

        async function saveState() {
            try {
                await fetch(`${API_BASE}/v1/state`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(state)
                });
            } catch (e) {
                showStatus('ä¿å­˜å¤±è´¥', 'error');
            }
        }

        async function getFundName(code) {
            try {
                const res = await fetch(`${API_BASE}/v1/fund/${code}/name`);
                const data = await res.json();
                return data.name || '';
            } catch {
                return '';
            }
        }

        async function refreshAll() {
            if (isRefreshing) return;
            if (state.sectors.length === 0) return;

            const allCodes = [];
            state.sectors.forEach(s => s.funds.forEach(f => { if (f.code) allCodes.push(f.code); }));
            if (allCodes.length === 0) return;

            isRefreshing = true;
            const btn = document.getElementById('refreshBtn');
            btn.innerHTML = '<span class="loading"></span>åˆ·æ–°ä¸­';
            btn.disabled = true;

            try {
                const res = await fetch(`${API_BASE}/v1/valuation/batch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fund_codes: allCodes })
                });

                if (!res.ok) throw new Error('è¯·æ±‚å¤±è´¥');

                const data = await res.json();
                valuations = {};
                (data.items || []).forEach(item => {
                    if (item?.fund_code) valuations[item.fund_code] = item;
                });

                render();
                lastRefreshTime = new Date();
                document.getElementById('updateTime').textContent =
                    `æ›´æ–°äº ${lastRefreshTime.toLocaleTimeString()}`;
            } catch (e) {
                showStatus('åˆ·æ–°å¤±è´¥: ' + e.message, 'error');
            } finally {
                isRefreshing = false;
                btn.innerHTML = 'ğŸ”„ åˆ·æ–°';
                btn.disabled = false;
            }
        }

        // ============ æ¿å—æ“ä½œ ============
        function addSector() {
            const name = document.getElementById('newSectorName').value.trim();
            if (!name) return;

            state.sectors.push({ name, funds: [] });
            saveState();
            render();
            closeModal('addSectorModal');
        }

        // ============ åŸºé‡‘æ“ä½œ ============
        async function addFund(sectorIndex) {
            const form = document.querySelector(`#sector-${sectorIndex} .add-row`);
            const codeInput = form.querySelector('input[name="code"]');
            const aliasInput = form.querySelector('input[name="alias"]');
            const code = codeInput.value.trim();
            let alias = aliasInput.value.trim();

            if (!code || !/^\d{6}$/.test(code)) {
                showStatus('è¯·è¾“å…¥6ä½åŸºé‡‘ä»£ç ', 'error');
                return;
            }

            // æ£€æŸ¥é‡å¤
            const exists = state.sectors[sectorIndex].funds.some(f => f.code === code);
            if (exists) {
                showStatus('è¯¥åŸºé‡‘å·²å­˜åœ¨', 'error');
                return;
            }

            // è‡ªåŠ¨è·å–åŸºé‡‘åç§°
            if (!alias) {
                const btn = form.querySelector('button');
                btn.innerHTML = '<span class="loading"></span>';
                btn.disabled = true;
                alias = await getFundName(code);
                btn.innerHTML = 'æ·»åŠ ';
                btn.disabled = false;
            }

            state.sectors[sectorIndex].funds.push({ code, alias });
            saveState();
            render();

            codeInput.value = '';
            aliasInput.value = '';

            // æ·»åŠ åç«‹å³åˆ·æ–°ä¼°å€¼
            refreshAll();
        }

        function deleteFund(sectorIndex, fundIndex) {
            state.sectors[sectorIndex].funds.splice(fundIndex, 1);
            saveState();
            render();
        }

        async function deleteSector(sectorIndex) {
            const sector = state.sectors[sectorIndex];
            if (!confirm(`ç¡®å®šåˆ é™¤æ¿å—ã€Œ${sector.name}ã€åŠå…¶æ‰€æœ‰åŸºé‡‘ï¼Ÿ`)) return;
            state.sectors.splice(sectorIndex, 1);
            saveState();
            render();
        }

        // ============ å‡€å€¼å†å²å¼¹çª— ============
        async function showNavHistory(fundCode) {
            const modal = document.getElementById('navHistoryModal');
            const title = document.getElementById('navHistoryTitle');
            const body = document.getElementById('navHistoryBody');

            const val = valuations[fundCode];
            const name = val?.fund_name || fundCode;
            title.textContent = `${name}ï¼ˆ${fundCode}ï¼‰è¿‘æœŸæ¶¨è·Œ`;
            body.innerHTML = '<p style="text-align:center;color:#9ca3af;padding:20px;"><span class="loading"></span>åŠ è½½ä¸­...</p>';
            modal.classList.add('show');

            try {
                const res = await fetch(`${API_BASE}/v1/fund/${fundCode}/nav-history?days=20`);
                const data = await res.json();
                const history = data.history || [];

                if (history.length === 0) {
                    body.innerHTML = '<p style="text-align:center;color:#9ca3af;padding:20px;">æš‚æ— æ•°æ®</p>';
                    return;
                }

                // æ‰¾æœ€å¤§ç»å¯¹å€¼ç”¨äºæŸ±çŠ¶å›¾æ¯”ä¾‹
                const maxAbs = Math.max(...history.map(h => Math.abs(h.change || 0)), 0.01);

                let html = `<table class="nav-history-table">
                    <thead><tr>
                        <th>æ—¥æœŸ</th>
                        <th>å‡€å€¼</th>
                        <th style="text-align:right">æ¶¨è·Œå¹…</th>
                        <th style="width:80px"></th>
                    </tr></thead><tbody>`;

                history.forEach(h => {
                    const change = h.change;
                    const cls = change > 0 ? 'up' : change < 0 ? 'down' : 'flat';
                    const changeStr = change != null ? ((change >= 0 ? '+' : '') + change.toFixed(2) + '%') : '--';
                    const navStr = h.nav != null ? h.nav.toFixed(4) : '--';

                    // è¿·ä½ æŸ±çŠ¶å›¾
                    const barWidth = change != null ? Math.round(Math.abs(change) / maxAbs * 60) : 0;
                    const barColor = change > 0 ? '#fca5a5' : change < 0 ? '#86efac' : '#e5e7eb';
                    const barHtml = barWidth > 0 ? `<span class="mini-bar" style="width:${barWidth}px;background:${barColor}"></span>` : '';

                    html += `<tr>
                        <td>${h.date || '--'}</td>
                        <td>${navStr}</td>
                        <td style="text-align:right" class="${cls}">${changeStr}</td>
                        <td>${barHtml}</td>
                    </tr>`;
                });

                html += '</tbody></table>';

                // ç´¯è®¡ç»Ÿè®¡ï¼ˆå¤åˆ©è®¡ç®—ï¼‰
                const validChanges = history.filter(h => h.change != null).map(h => h.change);
                if (validChanges.length >= 2) {
                    const compoundReturn = (arr) => {
                        let product = 1;
                        for (const c of arr) product *= (1 + c / 100);
                        return (product - 1) * 100;
                    };
                    const sum5 = compoundReturn(validChanges.slice(0, 5));
                    const sum10 = compoundReturn(validChanges.slice(0, 10));
                    const upDays = validChanges.filter(c => c > 0).length;
                    const downDays = validChanges.filter(c => c < 0).length;
                    html += `<div style="padding:8px 0;font-size:11px;color:#6b7280;display:flex;gap:16px;flex-wrap:wrap;">
                        <span>è¿‘5æ—¥ç´¯è®¡: <b style="color:${sum5>=0?'#dc2626':'#16a34a'}">${sum5>=0?'+':''}${sum5.toFixed(2)}%</b></span>
                        <span>è¿‘10æ—¥ç´¯è®¡: <b style="color:${sum10>=0?'#dc2626':'#16a34a'}">${sum10>=0?'+':''}${sum10.toFixed(2)}%</b></span>
                        <span>æ¶¨${upDays}å¤© è·Œ${downDays}å¤©</span>
                    </div>`;
                }

                body.innerHTML = html;
            } catch (e) {
                body.innerHTML = `<p style="text-align:center;color:#ef4444;padding:20px;">åŠ è½½å¤±è´¥: ${e.message}</p>`;
            }
        }

        // ============ è‡ªåŠ¨åˆ·æ–°ï¼ˆäº¤æ˜“æ—¶æ®µæ„ŸçŸ¥ï¼‰ ============
        function isTradeTime() {
            const now = new Date();
            const day = now.getDay();
            if (day === 0 || day === 6) return false;
            const hhmm = now.getHours() * 100 + now.getMinutes();
            // 9:15~11:35 å’Œ 12:55~15:05ï¼ˆç•™ç¼“å†²ï¼‰
            return (hhmm >= 915 && hhmm <= 1135) || (hhmm >= 1255 && hhmm <= 1505);
        }

        function startAutoRefresh() {
            if (autoRefreshTimer) return;
            _scheduleNextRefresh();
            updateRefreshTimer();
        }

        function _scheduleNextRefresh() {
            if (autoRefreshTimer) clearTimeout(autoRefreshTimer);
            const interval = isTradeTime() ? 30000 : 300000; // äº¤æ˜“æ—¶æ®µ30sï¼Œéäº¤æ˜“5min
            autoRefreshTimer = setTimeout(() => {
                if (state.sectors.some(s => s.funds.length > 0)) {
                    refreshAll();
                }
                _scheduleNextRefresh();
            }, interval);
        }

        function updateRefreshTimer() {
            const el = document.getElementById('refreshTimer');
            const dot = document.querySelector('.refresh-status .dot');
            const trading = isTradeTime();

            if (trading) {
                if (dot) dot.style.background = '#10b981';
                if (lastRefreshTime) {
                    const ago = Math.floor((Date.now() - lastRefreshTime) / 1000);
                    el.textContent = `${ago}så‰æ›´æ–° Â· 30såˆ·æ–°`;
                } else {
                    el.textContent = 'ğŸŸ¢ 30sè‡ªåŠ¨åˆ·æ–°ä¸­';
                }
            } else {
                if (dot) dot.style.background = '#9ca3af';
                if (lastRefreshTime) {
                    const ago = Math.floor((Date.now() - lastRefreshTime) / 1000);
                    const agoText = ago < 60 ? `${ago}s` : `${Math.floor(ago/60)}m`;
                    el.textContent = `â¸ éäº¤æ˜“æ—¶æ®µ Â· ${agoText}å‰æ›´æ–°`;
                } else {
                    el.textContent = 'â¸ éäº¤æ˜“æ—¶æ®µ';
                }
            }
            setTimeout(updateRefreshTimer, 1000);
        }

        // ============ æ¸²æŸ“ç•Œé¢ï¼ˆä¼°å€¼çœ‹æ¿ï¼‰ ============
        function render() {
            const container = document.getElementById('sectors');

            if (state.sectors.length === 0) {
                container.innerHTML = `
                    <div class="empty">
                        <div class="empty-icon">ğŸ“</div>
                        <p>ç‚¹å‡»"æ–°å»ºæ¿å—"å¼€å§‹</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = state.sectors.map((sector, si) => {
                // æŒ‰æ¶¨è·Œå¹…æ’åºï¼ˆç”±é«˜åˆ°ä½ï¼‰
                const sortedFunds = [...sector.funds].sort((a, b) => {
                    const valA = valuations[a.code];
                    const valB = valuations[b.code];
                    const changeA = valA?.estimation_change ?? -999;
                    const changeB = valB?.estimation_change ?? -999;
                    return changeB - changeA;
                });

                return `
                <div class="sector" id="sector-${si}">
                    <div class="sector-header">
                        <span class="sector-name">${sector.name}</span>
                        <div style="display:flex;gap:4px;">
                            <button class="btn-export" onclick="exportSectorImage(${si})" title="å¯¼å‡ºå›¾ç‰‡">ğŸ“·</button>
                            <button class="btn-export" onclick="deleteSector(${si})" title="åˆ é™¤æ¿å—" style="color:#ef4444;">ğŸ—‘</button>
                        </div>
                    </div>
                    ${sector.funds.length === 0 ?
                        '<div style="padding:20px;text-align:center;color:#9ca3af;font-size:12px;">æš‚æ— åŸºé‡‘</div>' :
                        `<table class="fund-table">
                            <thead>
                                <tr>
                                    <th>ä»£ç </th>
                                    <th>åç§°</th>
                                    <th style="text-align:right">æ¶¨è·Œå¹…</th>
                                    <th style="text-align:right">è¿‘5æ—¥</th>
                                    <th style="text-align:right">ç½®ä¿¡åº¦</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedFunds.map((fund) => {
                                    const fi = sector.funds.findIndex(f => f.code === fund.code);
                                    return renderFundRow(fund, si, fi);
                                }).join('')}
                            </tbody>
                        </table>`
                    }
                    <div class="add-row">
                        <input type="text" name="code" placeholder="ä»£ç " maxlength="6">
                        <input type="text" name="alias" placeholder="åç§°ï¼ˆè‡ªåŠ¨è·å–ï¼‰">
                        <button class="btn-primary" onclick="addFund(${si})">æ·»åŠ </button>
                    </div>
                </div>
            `}).join('');
        }

        function renderFundRow(fund, sectorIndex, fundIndex) {
            const val = valuations[fund.code];
            let changeText = '--';
            let changeClass = 'flat';
            let confidence = '--';
            let weekText = '--';
            let weekClass = 'flat';
            let displayName = fund.alias || '';
            let needsEtfLink = false;
            let isNav = false;

            if (val) {
                if (val.estimation_change !== null && val.estimation_change !== undefined) {
                    const change = val.estimation_change;
                    changeText = (change >= 0 ? '+' : '') + change.toFixed(2) + '%';
                    changeClass = change > 0 ? 'up' : change < 0 ? 'down' : 'flat';
                    if (val._source === 'nav') isNav = true;
                }
                if (val.week_change !== null && val.week_change !== undefined) {
                    const wc = val.week_change;
                    weekText = (wc >= 0 ? '+' : '') + wc.toFixed(2) + '%';
                    weekClass = wc > 0 ? 'up' : wc < 0 ? 'down' : 'flat';
                }
                confidence = (val.confidence * 100).toFixed(0) + '%';
                if (!displayName && val.fund_name) {
                    displayName = val.fund_name;
                }
                if (val.confidence < 0.15) {
                    needsEtfLink = true;
                }
            }

            // âœ“ æ ‡è®°ä½œä¸ºå°å·å†…è”å…ƒç´ ï¼Œå’Œæ•°å­—åœ¨åŒä¸€è¡Œ
            // _nav_date å­˜åœ¨ä¸”éä»Šå¤©æ—¶ï¼Œæ˜¾ç¤ºå‡€å€¼æ—¥æœŸï¼ˆå¦‚"2/13å‡€å€¼"ï¼‰
            let navMark = '';
            if (isNav) {
                const navDate = val?._nav_date;
                const todayStr = new Date().toISOString().slice(0, 10);
                if (navDate && navDate !== todayStr) {
                    const md = navDate.slice(5).replace(/^0/, '').replace(/-0?/, '/');
                    navMark = `<span style="font-size:9px;margin-left:2px;color:#f59e0b;font-weight:400;" title="${navDate}å‡€å€¼">${md}</span>`;
                } else {
                    navMark = '<span style="font-size:10px;margin-left:2px;color:#10b981;font-weight:400;">âœ“</span>';
                }
            }

            const etfBtn = needsEtfLink ?
                `<button onclick="showEtfLinkModal('${fund.code}')" title="è®¾ç½®ETFç©¿é€" style="color:#f59e0b;">âš™</button>` : '';

            return `
                <tr>
                    <td class="td-code" onclick="showNavHistory('${fund.code}')" title="ç‚¹å‡»æŸ¥çœ‹è¿‘æœŸæ¶¨è·Œ">${fund.code}</td>
                    <td class="td-name" title="${displayName}">${displayName}</td>
                    <td class="td-change ${changeClass}" style="white-space:nowrap;">${changeText}${navMark}</td>
                    <td class="td-change ${weekClass}">${weekText}</td>
                    <td class="td-confidence">${confidence}</td>
                    <td class="td-action" style="white-space:nowrap;">
                        ${etfBtn}
                        <button onclick="addToStrategy('${fund.code}')" title="åŠ å…¥ä½é¢‘ç½‘æ ¼" style="color:#10b981;">ğŸ“Œ</button>
                        <button onclick="deleteFund(${sectorIndex}, ${fundIndex})" title="åˆ é™¤">Ã—</button>
                    </td>
                </tr>
            `;
        }

        // ============ ETFæ˜ å°„è®¾ç½® ============
        function showEtfLinkModal(linkCode) {
            document.getElementById('etfLinkCode').value = linkCode;
            document.getElementById('etfTargetCode').value = '';
            document.getElementById('etfLinkModal').classList.add('show');
            document.getElementById('etfTargetCode').focus();
        }

        async function saveEtfLink() {
            const linkCode = document.getElementById('etfLinkCode').value.trim();
            const etfCode = document.getElementById('etfTargetCode').value.trim();

            if (!etfCode || !/^\d{6}$/.test(etfCode)) {
                showStatus('è¯·è¾“å…¥6ä½ETFä»£ç ', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/v1/etf-link`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ link_code: linkCode, etf_code: etfCode })
                });

                if (!res.ok) throw new Error('è®¾ç½®å¤±è´¥');

                showStatus(`å·²è®¾ç½® ${linkCode} -> ${etfCode}`, 'success');
                closeModal('etfLinkModal');

                // åˆ·æ–°ä¼°å€¼
                await refreshAll();
            } catch (e) {
                showStatus('è®¾ç½®å¤±è´¥: ' + e.message, 'error');
            }
        }

        async function clearEtfLink() {
            const linkCode = document.getElementById('etfLinkCode').value.trim();

            try {
                await fetch(`${API_BASE}/v1/etf-link/${linkCode}`, { method: 'DELETE' });
                showStatus(`å·²æ¸…é™¤ ${linkCode} çš„æ˜ å°„`, 'success');
                closeModal('etfLinkModal');
                await refreshAll();
            } catch (e) {
                showStatus('æ¸…é™¤å¤±è´¥', 'error');
            }
        }

        // ============ åŠ å…¥ç­–ç•¥æŒä»“ ============
        async function addToStrategy(fundCode) {
            // å…ˆæ£€æŸ¥æ˜¯å¦å·²åœ¨æŒä»“ä¸­
            try {
                const res = await fetch(`${API_BASE}/v1/position/${encodeURIComponent(fundCode)}`);
                const pos = await res.json();
                if (pos.has_position) {
                    showStatus(`${fundCode} å·²åœ¨ä½é¢‘ç½‘æ ¼ä¸­`, 'info');
                    switchTab('strategy');
                    return;
                }
            } catch {}
            // ç›´æ¥æ‰“å¼€ä¹°å…¥å¼¹çª—
            showBuyModal(fundCode);
        }

        // ============ ä»ç­–ç•¥é¢æ¿ç§»é™¤åŸºé‡‘ ============
        async function removeFromStrategy(fundCode) {
            const displayCode = fundCode.includes('__') ? fundCode.replace('__', ' [') + ']' : fundCode;
            if (!confirm(`ç¡®å®šå°† ${displayCode} ä»ä½é¢‘ç½‘æ ¼ç§»é™¤ï¼Ÿï¼ˆä¼šåˆ é™¤æ‰€æœ‰æŒä»“è®°å½•ï¼‰`)) return;
            try {
                const res = await fetch(`${API_BASE}/v1/position/${encodeURIComponent(fundCode)}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('ç§»é™¤å¤±è´¥');
                showStatus(`å·²ç§»é™¤ ${displayCode}`, 'success');
                loadStrategyPanel();
            } catch (e) {
                showStatus('ç§»é™¤å¤±è´¥: ' + e.message, 'error');
            }
        }

        // ============ ç­–ç•¥é¢æ¿ ============
        // ============================================================
        // v5.13: è¡Œæƒ…æ¨¡å¼ç®¡ç†
        // ============================================================
        let _currentRegime = 'neutral';
        let _regimeAuto = true;
        let _regimeManual = false;


        async function loadRegimeStatus() {
            try {
                const res = await fetch(`${API_BASE}/v1/market-regime`);
                const data = await res.json();
                _currentRegime = data.regime || 'neutral';
                if (_currentRegime === 'bull') _currentRegime = 'neutral';  // v5.17: bullå·²ç¦ç”¨
                _regimeAuto = data.auto !== false;
                _regimeManual = !!data.manual;
                updateRegimeUI();
            } catch(e) { console.warn('loadRegimeStatus error:', e); }
        }

        async function setRegimeManual(regime) {
            try {
                await fetch(`${API_BASE}/v1/market-regime`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ regime, auto: true, manual_override: true }),
                });
                _currentRegime = regime;
                _regimeManual = true;
                updateRegimeUI();
                loadStrategyPanel();
            } catch(e) { showStatus('è®¾ç½®è¡Œæƒ…æ¨¡å¼å¤±è´¥', 'error'); }
        }

        async function toggleRegimeAuto() {
            try {
                if (_regimeManual) {
                    // æ¢å¤è‡ªåŠ¨
                    await fetch(`${API_BASE}/v1/market-regime`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ regime: 'neutral', auto: true, manual_override: false }),
                    });
                    _regimeManual = false;
                }
                await loadRegimeStatus();
                loadStrategyPanel();
            } catch(e) { showStatus('åˆ‡æ¢è‡ªåŠ¨è¯†åˆ«å¤±è´¥', 'error'); }
        }

        function updateRegimeUI() {
            // v5.17: å†…è”regimeæŒ‰é’®åœ¨loadStrategyPanelä¸­æ¸²æŸ“ï¼Œæ­¤å¤„æ›´æ–°å·²å­˜åœ¨çš„æŒ‰é’®
            document.querySelectorAll('.ri-btn').forEach(btn => {
                const text = btn.textContent;
                const isBear = text.includes('ç†Š');
                const regime = isBear ? 'bear' : 'neutral';
                btn.className = 'ri-btn';
                if (regime === _currentRegime) btn.classList.add(`active-${_currentRegime}`);
            });
            const srcLabel = document.getElementById('regimeSourceLabel');
            if (srcLabel) {
                srcLabel.textContent = _regimeManual ? 'æ‰‹åŠ¨' : 'è‡ªåŠ¨';
                srcLabel.className = 'regime-auto-badge' + (_regimeManual ? ' manual' : '');
            }
        }

        async function loadStrategyPanel() {
            const panel = document.getElementById('strategyPanel');
            panel.innerHTML = '<div style="text-align:center;padding:20px;color:#9ca3af;"><span class="loading"></span>åŠ è½½ä¿¡å·ä¸­...</div>';

            try {
                // å¹¶è¡Œè·å–ä¿¡å· + æŒä»“
                const [sigRes, posRes] = await Promise.all([
                    fetch(`${API_BASE}/v1/strategy/signals`),
                    fetch(`${API_BASE}/v1/positions`),
                ]);
                const sigData = await sigRes.json();
                const posData = await posRes.json();
                const signals = sigData.signals || [];
                const funds = posData.funds || {};

                if (signals.length === 0 && Object.keys(funds).length === 0) {
                    panel.innerHTML = `
                        <div class="empty">
                            <div class="empty-icon">ğŸ“¡</div>
                            <p>æš‚æ— æŒä»“å’Œä¿¡å·æ•°æ®</p>
                            <p style="font-size:11px;color:#9ca3af;margin-top:8px;">åœ¨å®æ—¶ä¼°å€¼ä¸­è§‚å¯ŸåŸºé‡‘ï¼Œç„¶ååœ¨æ­¤å½•å…¥æŒä»“</p>
                        </div>
                        <div class="add-position-bar">
                            <span>å¿«é€Ÿæ·»åŠ æŒä»“åŸºé‡‘ï¼š</span>
                            <input type="text" id="quickAddCode" placeholder="6ä½ä»£ç " maxlength="6">
                            <button class="btn-success" onclick="quickAddPosition()" style="padding:6px 12px;font-size:12px;border:none;border-radius:4px;cursor:pointer;">å½•å…¥ä¹°å…¥</button>
                        </div>
                    `;
                    return;
                }

                const pb = sigData.portfolio_budget;
                const cashReserveRatio = pb ? pb.cash_reserve_ratio : 0.30;

                let html = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                    <div style="display:flex;align-items:center;">
                        <span style="font-size:12px;color:#6b7280;">ä¿¡å·ç”Ÿæˆäº ${sigData.generated_at || '--'}</span>
                        <div class="regime-inline" id="regimeInline">
                            <button class="ri-btn ${_currentRegime === 'neutral' ? 'active-neutral' : ''}" onclick="setRegimeManual('neutral')">âš–ï¸ éœ‡è¡</button>
                            <button class="ri-btn ${_currentRegime === 'bear' ? 'active-bear' : ''}" onclick="setRegimeManual('bear')">ğŸ» ç†Šå¸‚</button>
                            <span id="regimeSourceLabel" class="regime-auto-badge ${_regimeManual ? 'manual' : ''}" onclick="toggleRegimeAuto()" title="ç‚¹å‡»åˆ‡æ¢è‡ªåŠ¨/æ‰‹åŠ¨">${_regimeManual ? 'æ‰‹åŠ¨' : 'è‡ªåŠ¨'}</span>
                        </div>
                    </div>
                    <div style="display:flex;gap:6px;">
                        <button class="btn-warning" onclick="showAddInstanceModal()" style="padding:4px 12px;font-size:11px;">æ–°å¢æ¨¡å—</button>
                        <button class="btn-success" onclick="showGroupModal()" style="padding:4px 12px;font-size:11px;">â• æ–°å»ºåˆ†ç»„</button>
                        <button class="btn-primary" onclick="loadStrategyPanel()" style="padding:4px 12px;font-size:11px;">åˆ·æ–°ä¿¡å·</button>
                    </div>
                </div>`;

                // æŒ‰åˆ†ç»„è®¡ç®—é¢„ç®—çš„è¾…åŠ©å‡½æ•°ï¼ˆé¢„ç®—ç”¨æˆæœ¬å£å¾„ï¼‰
                function calcGroupBudget(fundCodes) {
                    let maxInvest = 0, invested = 0;
                    for (const code of fundCodes) {
                        const f = funds[code];
                        if (!f) continue;
                        maxInvest += (f.max_position || 5000);
                        // ä¼˜å…ˆä½¿ç”¨å¸‚å€¼ï¼ˆä¸æŒä»“æ±‡æ€»å±•ç¤ºå£å¾„ä¸€è‡´ï¼‰ï¼Œå›é€€åˆ°æˆæœ¬æ±‚å’Œ
                        const mv = sigMap[code]?.market_analysis?.market_value;
                        if (mv != null && mv > 0) {
                            invested += mv;
                        } else {
                            const holding = (f.batches || []).filter(b => b.status === 'holding');
                            invested += holding.reduce((s, b) => s + (b.amount || 0), 0);
                        }
                    }
                    maxInvest *= (1 - cashReserveRatio);
                    return { maxInvest, invested, available: Math.max(0, maxInvest - invested) };
                }
                function renderGroupBudgetBar(budget) {
                    if (budget.maxInvest <= 0) return '';
                    const pct = (budget.invested / budget.maxInvest * 100).toFixed(0);
                    const clr = pct > 85 ? '#ef4444' : pct > 60 ? '#f59e0b' : '#10b981';
                    return `<div style="display:flex;align-items:center;gap:8px;padding:5px 14px;font-size:10px;color:#9ca3af;border-bottom:1px solid #f1f5f9;">
                        <span>é¢„ç®—</span>
                        <div style="flex:1;height:4px;background:#f1f5f9;border-radius:2px;overflow:hidden;">
                            <div style="width:${Math.min(pct,100)}%;height:100%;background:${clr};border-radius:2px;"></div>
                        </div>
                        <span>Â¥${budget.invested.toFixed(0)} / Â¥${budget.maxInvest.toFixed(0)}</span>
                        <span>å¯ç”¨ <b style="color:${budget.available > 0 ? '#059669' : '#dc2626'};">Â¥${budget.available.toFixed(0)}</b></span>
                    </div>`;
                }

                // === æŒ‰åˆ†ç»„ç»„ç»‡ä¿¡å·å¡ç‰‡ ===
                // v5.4 ä¼˜åŒ–: è‡ªåŠ¨æ ¹æ®è§’è‰²æ ‡ç­¾åŒæ­¥åˆ†ç»„
                const allFundCodes = signals.map(s => s.fund_code);
                const groupData = autoSyncGroupsFromOwnerTags(allFundCodes);
                const groupedCodes = new Set();
                for (const grp of groupData.groups) {
                    for (const c of grp.fund_codes) groupedCodes.add(c);
                }

                // ä¿¡å·è½¬ä¸ºmapæ–¹ä¾¿æŸ¥æ‰¾
                const sigMap = {};
                for (const sig of signals) sigMap[sig.fund_code] = sig;

                // æ¸²æŸ“ä¸€ä¸ªåˆ†ç»„
                function renderGroupSection(groupId, groupName, fundCodes, showHeader) {
                    // è¿‡æ»¤å‡ºæœ‰ä¿¡å·çš„åŸºé‡‘
                    const codesWithSig = fundCodes.filter(c => sigMap[c]);
                    if (codesWithSig.length === 0 && showHeader) return '';

                    let sectionHtml = '';
                    if (showHeader) {
                        const gBudget = calcGroupBudget(codesWithSig);
                        sectionHtml += `<div class="strategy-group" data-group-id="${groupId}">
                            <div class="strategy-group-header">
                                <span class="group-name" onclick="showGroupModal('${groupId}')" title="ç‚¹å‡»é‡å‘½å">${groupName}</span>
                                <div class="group-actions">
                                    <button onclick="exportStrategyGroupImage('${groupId}')" title="å¯¼å‡ºå›¾ç‰‡">ğŸ“·</button>
                                    <button onclick="showGroupModal('${groupId}')" title="é‡å‘½å">âœï¸</button>
                                    <button onclick="deleteGroup('${groupId}')" title="åˆ é™¤åˆ†ç»„" style="color:#ef4444;">ğŸ—‘</button>
                                </div>
                            </div>
                            ${renderGroupBudgetBar(gBudget)}
                            <div class="strategy-group-body">`;
                    }

                    for (const code of codesWithSig) {
                        sectionHtml += renderSignalCard(code, sigMap[code], funds[code]);
                    }

                    if (showHeader) {
                        sectionHtml += `</div></div>`;
                    }
                    return sectionHtml;
                }

                // æ¸²æŸ“å„åˆ†ç»„
                for (const grp of groupData.groups) {
                    html += renderGroupSection(grp.id, grp.name, grp.fund_codes, true);
                }

                // æœªåˆ†ç»„çš„åŸºé‡‘
                const ungroupedCodes = signals.map(s => s.fund_code).filter(c => !groupedCodes.has(c));
                if (ungroupedCodes.length > 0) {
                    if (groupData.groups.length > 0) {
                        html += `<div class="ungrouped-label">æœªåˆ†ç»„</div>`;
                    }
                    for (const code of ungroupedCodes) {
                        html += renderSignalCard(code, sigMap[code], funds[code]);
                    }
                }

                panel.innerHTML = html;
            } catch (e) {
                panel.innerHTML = `<div style="text-align:center;padding:20px;color:#ef4444;">åŠ è½½å¤±è´¥: ${e.message}</div>`;
            }

                // æ¸²æŸ“å•ä¸ªä¿¡å·å¡ç‰‡çš„å‡½æ•°ï¼ˆåœ¨ä¸Šé¢è¢« renderGroupSection è°ƒç”¨ï¼‰
                function renderSignalCard(code, sig, fundPos) {
                    const holdingBatches = (fundPos?.batches?.filter(b => b.status === 'holding') || [])
                        .sort((a, b) => a.buy_date.localeCompare(b.buy_date));
                    const hasPos = holdingBatches.length > 0;

                    let badgeCls = 'hold';
                    if (sig.action === 'sell') badgeCls = 'sell';
                    else if (sig.action === 'buy') badgeCls = 'buy';
                    if (sig.alert) badgeCls = 'alert';
                    if (sig.signal_name && sig.signal_name.includes('ä½ç½®ä¿¡')) badgeCls = 'alert';

                    // è§£æå¤åˆé”®ï¼šcode å¯èƒ½æ˜¯ "017193__è€å…¬"
                    let realCode = code, ownerTag = '';
                    if (code.includes('__')) {
                        const parts = code.split('__');
                        realCode = parts[0];
                        ownerTag = parts[1] || '';
                    }

                    const fundName = fundPos?.fund_name || valuations[realCode]?.fund_name || '';
                    const ownerBadge = ownerTag ? `<span style="margin-left:6px;background:#e0e7ff;color:#4338ca;font-size:10px;font-weight:600;padding:1px 6px;border-radius:3px;">${ownerTag}</span>` : '';
                    // ä½¿ç”¨ encodeURIComponent ç¡®ä¿å¤åˆé”®åœ¨ URL ä¸­å®‰å…¨
                    const safeCode = encodeURIComponent(code);

                    // v5.13: é€‚é…è¯„åˆ†å¾½ç« 
                    let fitBadge = '';
                    const _ma = sig.market_analysis || {};
                    const fitScore = _ma.fitness_score;
                    const fitGrade = _ma.fitness_grade;
                    if (fitScore != null && fitGrade) {
                        const fitCls = fitScore >= 70 ? 'grade-A' : fitScore >= 55 ? 'grade-B' : fitScore >= 40 ? 'grade-C' : fitScore >= 25 ? 'grade-D' : 'grade-E';
                        fitBadge = `<span class="fitness-badge ${fitCls}" title="é€‚é…è¯„åˆ† ${Math.round(fitScore)}åˆ† (${fitGrade})">${Math.round(fitScore)}</span>`;
                    }

                    // v5.17: è¡Œæƒ…æ¨¡å¼æ ‡ç­¾ï¼ˆç†Šå¸‚æ—¶æ˜¾ç¤ºï¼‰
                    let regimeBadge = '';
                    if (_ma.market_regime === 'bear') {
                        const rSrc = _ma.regime_source === 'manual' ? 'æ‰‹åŠ¨' : 'è‡ªåŠ¨';
                        regimeBadge = `<span style="font-size:10px;margin-left:2px;" title="${rSrc}è¯†åˆ«">ğŸ»</span>`;
                    }

                    let html = `<div class="signal-card">
                        <div class="signal-card-header">
                            <div class="fund-info">
                                <span class="code" onclick="showNavHistory('${realCode}')">${realCode}</span>
                                ${ownerBadge}${fitBadge}${regimeBadge}
                                ${fundName ? `<span style="margin-left:6px;font-weight:400;color:#6b7280;font-size:12px;">${fundName}</span>` : ''}
                            </div>
                            <div style="display:flex;align-items:center;gap:6px;">
                                <span class="signal-badge ${badgeCls}">${sig.signal_name}</span>
                                <button onclick="showSetOwnerModal('${code}')" title="è®¾ç½®æ ‡ç­¾/æŒä»“äºº" style="background:none;border:none;color:#a5b4fc;cursor:pointer;font-size:12px;padding:2px;">ğŸ‘¤</button>
                                <button onclick="showAssignGroupModal('${code}')" title="åˆ†é…åˆ°åˆ†ç»„" style="background:none;border:none;color:#9ca3af;cursor:pointer;font-size:12px;padding:2px;">ğŸ“</button>
                                <button onclick="removeFromStrategy('${code}')" title="ä»ä½é¢‘ç½‘æ ¼ç§»é™¤" style="background:none;border:none;color:#d1d5db;cursor:pointer;font-size:13px;padding:2px;">Ã—</button>
                            </div>
                        </div>
                        <div class="signal-card-body" style="padding:6px 14px 4px;">`;

                    const signalsToShow = sig.all_signals && sig.all_signals.length > 0 ? sig.all_signals : [sig];
                    const fifo = sig.fifo_sell_plan;
                    if (fifo && fifo.steps && fifo.steps.length > 0) {
                        html += `<div style="background:#fef2f2;border:1px solid #fecaca;border-radius:6px;padding:8px 10px;margin-bottom:4px;">
                            <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:4px;">
                                <span style="font-weight:600;color:#dc2626;font-size:12px;">${fifo.instruction}</span>
                                <span style="font-size:10px;color:#9ca3af;">æ¶‰åŠ ${fifo.batch_count} ä¸ªæ‰¹æ¬¡</span>
                            </div>`;
                        if (fifo.has_passthrough) {
                            html += `<div style="background:#fef3c7;border-radius:4px;padding:3px 6px;margin-bottom:4px;font-size:10px;color:#92400e;">
                                âš ï¸ æ”¯ä»˜å®æŒ‰å…ˆè¿›å…ˆå‡ºæ‰£å‡ï¼Œä¸­é—´æ‰¹æ¬¡ä¼šè¢«"ç©¿è¿‡"ä¸€å¹¶å–å‡º
                            </div>`;
                        }
                        html += `<div style="font-size:10px;color:#6b7280;">`;
                        for (const step of fifo.steps) {
                            const ptTag = step.is_passthrough ? '<span style="color:#d97706;font-weight:600;">[ç©¿è¿‡]</span> ' : '';
                            const profitColor = (step.estimated_net_profit||0) >= 0 ? '#dc2626' : '#16a34a';
                            html += `<div style="display:flex;justify-content:space-between;padding:2px 0;border-bottom:1px dashed #f3f4f6;">
                                <span>${ptTag}${step.batch_id} Â· ${step.buy_date} Â· æŒæœ‰${step.hold_days}å¤© Â· ${step.reason}</span>
                                <span style="white-space:nowrap;">${step.sell_shares}ä»½ Â· è´¹ç‡${step.fee_rate}% Â· <b style="color:${profitColor}">Â¥${step.estimated_net_profit?.toFixed(2) || '--'}</b></span>
                            </div>`;
                        }
                        html += `<div style="display:flex;justify-content:space-between;padding:3px 0;font-weight:600;color:#374151;">
                            <span>åˆè®¡</span>
                            <span>æ‰‹ç»­è´¹ Â¥${fifo.total_estimated_fee?.toFixed(2) || '--'} Â· å‡€æ”¶ç›Š <b style="color:${(fifo.total_estimated_profit||0) >= 0 ? '#dc2626' : '#16a34a'}">Â¥${fifo.total_estimated_profit?.toFixed(2) || '--'}</b></span>
                        </div>`;
                        html += `</div></div>`;
                        for (const s of signalsToShow) {
                            if (s.action === 'buy' && s.amount) {
                                html += `<div style="background:#ecfdf5;border:1px solid #a7f3d0;border-radius:6px;padding:6px 10px;margin-bottom:4px;">
                                    <div style="font-size:11px;color:#374151;">
                                        <span style="font-weight:600;color:#059669;">${s.signal_name}</span>
                                        <span style="margin-left:6px;">${s.reason || ''}</span>
                                    </div>
                                    <div style="font-size:11px;color:#059669;font-weight:600;margin-top:2px;">å»ºè®®ä¹°å…¥: Â¥${s.amount.toFixed(2)}</div>
                                </div>`;
                            } else if (s.alert && s.action !== 'sell') {
                                html += `<div style="background:#fef3c7;border:1px solid #fde68a;border-radius:6px;padding:6px 10px;margin-bottom:4px;">
                                    <div style="font-size:11px;color:#92400e;">
                                        <span style="font-weight:600;">âš ï¸ ${s.signal_name}</span>
                                        <span style="margin-left:4px;">${s.reason || ''}</span>
                                    </div>
                                </div>`;
                            }
                        }
                        // v5.12: å»¶è¿Ÿå›è¡¥å»ºè®®ï¼ˆæ­¢ç›ˆåä¸ç«‹å³ä¹°å…¥ï¼Œå‡€å€¼å›è½åˆ°è§¦å‘ä»·æ—¶å›è¡¥ï¼‰
                        if (sig.rebuy_recommendation) {
                            const rb = sig.rebuy_recommendation;
                            const triggerInfo = rb.trigger_nav ? `å‡€å€¼â‰¤${rb.trigger_nav}æ—¶è§¦å‘` : `å›è¡¥${Math.round((rb.ratio||0)*100)}%`;
                            const windowInfo = rb.window_days ? `${rb.window_days}å¤©å†…æœ‰æ•ˆ` : '';
                            html += `<div style="background:#eef2ff;border:1px solid #c7d2fe;border-radius:6px;padding:6px 10px;margin-bottom:4px;">
                                <div style="display:flex;justify-content:space-between;align-items:baseline;">
                                    <div style="font-size:11px;color:#4338ca;">
                                        <span style="font-weight:600;">ğŸ”„ å»¶è¿Ÿå›è¡¥</span>
                                        <span style="margin-left:6px;">è¶‹åŠ¿${rb.trend || ''}ï¼Œ${triggerInfo}${windowInfo ? 'ï¼Œ'+windowInfo : ''}</span>
                                    </div>
                                    <div style="font-size:11px;color:#4f46e5;font-weight:600;">å›è¡¥é‡‘é¢: Â¥${rb.amount?.toFixed(2) || '--'}</div>
                                </div>
                            </div>`;
                        }
                    } else {
                        for (const s of signalsToShow) {
                            if (s.action === 'sell' && s.target_batch_id && s.fee_info) {
                                const fi = s.fee_info;
                                html += `<div style="background:#fef2f2;border:1px solid #fecaca;border-radius:6px;padding:6px 10px;margin-bottom:4px;">
                                <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:2px;">
                                    <div style="font-size:11px;color:#374151;">
                                        <span style="font-weight:600;color:#dc2626;">${s.signal_name}</span>
                                        <span style="margin-left:6px;">${s.reason || ''}</span>
                                    </div>
                                    <span style="font-size:10px;color:#9ca3af;white-space:nowrap;margin-left:8px;">æ‰¹æ¬¡ ${s.target_batch_id}</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;align-items:baseline;">
                                    <div style="font-size:10px;color:#6b7280;">è´¹ç‡ <b>${fi.sell_fee_rate}%</b>&ensp;æ‰‹ç»­è´¹ <b>Â¥${fi.estimated_fee?.toFixed(2) || '--'}</b>&ensp;å‡€æ”¶ç›Š <b style="color:${(fi.estimated_net_profit||0) >= 0 ? '#dc2626' : '#16a34a'}">Â¥${fi.estimated_net_profit?.toFixed(2) || '--'}</b></div>
                                    <div style="font-size:12px;font-weight:600;color:#dc2626;white-space:nowrap;">å»ºè®®å–å‡º: ${s.sell_shares}ä»½ ${s.sell_pct ? `(è¯¥æ‰¹æ¬¡${s.sell_pct}%)` : ''}</div>
                                </div>
                            </div>`;
                                // v5.12: å»¶è¿Ÿå›è¡¥å»ºè®®
                                if (s.rebuy_recommendation || sig.rebuy_recommendation) {
                                    const rb = s.rebuy_recommendation || sig.rebuy_recommendation;
                                    const triggerInfo = rb.trigger_nav ? `å‡€å€¼â‰¤${rb.trigger_nav}æ—¶è§¦å‘` : `å›è¡¥${Math.round((rb.ratio||0)*100)}%`;
                                    const windowInfo = rb.window_days ? `${rb.window_days}å¤©å†…æœ‰æ•ˆ` : '';
                                    html += `<div style="background:#eef2ff;border:1px solid #c7d2fe;border-radius:6px;padding:6px 10px;margin-bottom:4px;">
                                        <div style="display:flex;justify-content:space-between;align-items:baseline;">
                                            <div style="font-size:11px;color:#4338ca;">
                                                <span style="font-weight:600;">ğŸ”„ å»¶è¿Ÿå›è¡¥</span>
                                                <span style="margin-left:6px;">è¶‹åŠ¿${rb.trend || ''}ï¼Œ${triggerInfo}${windowInfo ? 'ï¼Œ'+windowInfo : ''}</span>
                                            </div>
                                            <div style="font-size:11px;color:#4f46e5;font-weight:600;">å›è¡¥é‡‘é¢: Â¥${rb.amount?.toFixed(2) || '--'}</div>
                                        </div>
                                    </div>`;
                                }
                            } else if (s.action === 'buy' && s.amount) {
                                html += `<div style="background:#ecfdf5;border:1px solid #a7f3d0;border-radius:6px;padding:6px 10px;margin-bottom:4px;">
                                <div style="font-size:11px;color:#374151;">
                                    <span style="font-weight:600;color:#059669;">${s.signal_name}</span>
                                    <span style="margin-left:6px;">${s.reason || ''}</span>
                                </div>
                                <div style="font-size:11px;color:#059669;font-weight:600;margin-top:2px;">å»ºè®®ä¹°å…¥: Â¥${s.amount.toFixed(2)}</div>
                            </div>`;
                            } else if (s.alert) {
                                html += `<div style="background:#fef3c7;border:1px solid #fde68a;border-radius:6px;padding:6px 10px;margin-bottom:4px;">
                                <div style="font-size:11px;color:#92400e;">
                                    <span style="font-weight:600;">âš ï¸ ${s.signal_name}</span>
                                    <span style="margin-left:4px;">${s.reason || ''}</span>
                                </div>
                            </div>`;
                            } else if (s !== sig) {
                                html += `<div style="font-size:11px;color:#6b7280;padding:2px 0;">${s.signal_name}: ${s.reason || ''}</div>`;
                            }
                        }
                    }
                    if (signalsToShow.length === 1 && sig.action === 'hold' && !sig.alert) {
                        html += `<div class="signal-reason" style="margin-bottom:4px;">${sig.reason || ''}</div>`;
                    }
                    if (sig.alert && sig.alert_msg && !(sig.all_signals && sig.all_signals.some(s => s.alert))) {
                        html += `<div class="signal-alert" style="margin-bottom:4px;">${sig.alert_msg}</div>`;
                    }
                    html += '</div>';

                    // è¡Œæƒ…åˆ†æåŒºåŸŸ
                    const ma = sig.market_analysis;
                    if (ma && ma.day_changes) {
                        html += `<div class="market-analysis">`;
                        const days = [...ma.day_changes].reverse();
                        const maxAbs = Math.max(...days.map(d => Math.abs(d.change || 0)), 0.5);
                        const upH = 30, downH = 30;
                        html += `<div class="trend-bar">`;
                        for (let di = 0; di < days.length; di++) {
                            const d = days[di];
                            const val = d.change ?? 0;
                            const barH = Math.max(Math.abs(val) / maxAbs * 26, 1);
                            const color = val > 0 ? '#ef4444' : val < 0 ? '#10b981' : '#d1d5db';
                            const valColor = val > 0 ? '#dc2626' : val < 0 ? '#059669' : '#9ca3af';
                            const dateLabel = d.date ? d.date.slice(5).replace('-', '/') : '';
                            const srcTag = d.source === 'estimation' ? '<sup style="font-size:5px;color:#a78bfa;margin-left:1px;">ä¼°</sup>' : '';
                            const valStr = (val > 0 ? '+' : '') + val.toFixed(2) + '%';
                            html += `<div class="day-bar">
                                <div class="bar-upper" style="height:${upH}px;">
                                    ${val > 0 ? `<span class="bar-value" style="color:${valColor}">${valStr}${srcTag}</span><div class="bar-fill" style="background:${color};height:${barH}px;"></div>` : ''}
                                </div>
                                <div class="bar-lower" style="height:${downH}px;border-top:1px solid #e5e7eb;">
                                    ${val <= 0 ? `<div class="bar-fill" style="background:${color};height:${barH}px;"></div><span class="bar-value" style="color:${valColor}">${valStr}${srcTag}</span>` : ''}
                                </div>
                                <span class="bar-label">${dateLabel}</span>
                            </div>`;
                        }
                        html += `</div>`;
                        html += `<div class="market-stats">`;
                        const _s = (v, label) => {
                            if (v === null || v === undefined) return '';
                            const cls = v > 0 ? 'up' : v < 0 ? 'down' : 'flat';
                            return `<div class="stat-item"><span class="stat-label">${label}:</span><span class="stat-value ${cls}">${v > 0 ? '+' : ''}${v}%</span></div>`;
                        };
                        html += _s(ma.short_3d, '3æ—¥');
                        html += _s(ma.short_5d, '5æ—¥');
                        html += _s(ma.mid_10d, '10æ—¥');
                        html += _s(ma.long_20d, '20æ—¥');
                        if (ma.trend) {
                            const trendColor = {'è¿è·Œ':'#dc2626','åå¼±':'#f59e0b','è¿æ¶¨':'#059669','åå¼º':'#059669','éœ‡è¡':'#6b7280','ä¸­æœŸèµ°å¼±':'#dc2626','ä¸­æœŸèµ°å¼º':'#059669'}[ma.trend] || '#6b7280';
                            html += `<div class="stat-item"><span class="stat-label">è¶‹åŠ¿:</span><span class="stat-value" style="color:${trendColor}">${ma.trend}</span></div>`;
                        }
                        if (ma.current_nav) {
                            html += `<div class="stat-item"><span class="stat-label">ä¼°ç®—å‡€å€¼:</span><span class="stat-value flat">${ma.current_nav}</span></div>`;
                        }
                        if (ma.total_profit_pct !== null && ma.total_profit_pct !== undefined) {
                            const clsP = ma.total_profit_pct > 0 ? 'up' : ma.total_profit_pct < 0 ? 'down' : 'flat';
                            html += `<div class="stat-item"><span class="stat-label">æ€»æµ®ç›ˆ:</span><span class="stat-value ${clsP}">${ma.total_profit_pct > 0 ? '+' : ''}${ma.total_profit_pct}%</span></div>`;
                        }
                        if (ma.confidence != null) {
                            const confColor = ma.confidence >= 0.6 ? '#059669' : ma.confidence >= 0.4 ? '#d97706' : '#dc2626';
                            html += `<div class="stat-item"><span class="stat-label">ç½®ä¿¡åº¦:</span><span class="stat-value" style="color:${confColor}">${(ma.confidence * 100).toFixed(0)}%</span></div>`;
                        }
                        if (ma.covered_weight != null) {
                            html += `<div class="stat-item"><span class="stat-label">è¦†ç›–:</span><span class="stat-value flat">${ma.covered_weight}%${ma.residual_weight ? `<span style="color:#d97706;font-size:9px;margin-left:1px;">+æ®‹å·®${ma.residual_weight}%</span>` : ''}</span></div>`;
                        }
                        const sp = ma.strategy_params || {};
                        if (sp.risk_multiplier != null && sp.risk_multiplier !== 1.0) {
                            const rmColor = sp.risk_multiplier > 1.2 ? '#d97706' : sp.risk_multiplier < 0.9 ? '#059669' : '#6b7280';
                            html += `<div class="stat-item"><span class="stat-label">é£é™©ç³»æ•°:</span><span class="stat-value" style="color:${rmColor}">${sp.risk_multiplier}Ã—</span></div>`;
                        }
                        if (sp.vol_sensitivity != null) {
                            const vs = sp.vol_sensitivity;
                            const vsColor = Math.abs(vs - 1.0) > 0.05 ? (vs > 1.0 ? '#d97706' : '#059669') : '#6b7280';
                            const vsSource = sp.vol_sensitivity_source === 'manual' ? 'æ‰‹åŠ¨' : sp.vol_sensitivity_source === 'auto' ? 'è‡ªåŠ¨' : 'é»˜è®¤';
                            html += `<div class="stat-item"><span class="stat-label">çµæ•åº¦:</span><span class="stat-value" style="color:${vsColor};cursor:pointer;border-bottom:1px dashed ${vsColor};" onclick="showVolSensitivityModal('${code}')" title="ç‚¹å‡»è°ƒæ•´çµæ•åº¦ï¼ˆå½“å‰æ¥æº:${vsSource}ï¼‰">${vs.toFixed(2)}Ã—<sup style="font-size:7px;color:#9ca3af;margin-left:1px;">${vsSource}</sup></span></div>`;
                        }
                        html += `<button class="strategy-info-btn" onclick="toggleStrategyInfo('${code}')" title="ç­–ç•¥è§¦å‘æ¡ä»¶">?</button>`;
                        html += `</div>`;
                        html += `<div class="strategy-info-box" id="strategy-info-${code}">
                            <div style="display:flex;flex-direction:column;gap:4px;">
                                <div style="display:flex;align-items:baseline;gap:6px;">
                                    <span style="display:inline-block;background:#d1fae5;color:#059669;font-size:9px;font-weight:600;padding:1px 5px;border-radius:3px;flex-shrink:0;">ä¹°å…¥</span>
                                    <span>å¤§è·Œ â‰¤${sp.dip_buy_threshold||'--'}% Â· è¿è·Œä½å¸ â‰¤${sp.consecutive_dip_trigger||'--'}%ä¸”å‰æ—¥è·Œ Â· è¡¥ä»“æœ€å¤š${sp.supplement_max_count||3}æ¬¡(æµ®äºâ‰¤${sp.supplement_loss_min||'--'}%ä¸”å½“æ—¥â‰¤${sp.supplement_trigger||'--'}%ï¼Œé—´éš”â‰¥2äº¤æ˜“æ—¥+å†è·Œâ‰¥1.2%) Â· è¶‹åŠ¿å»ºä»“(5æ—¥â‰¤-3%æˆ–10æ—¥â‰¤-5%) Â· <b style="color:#4f46e5;">å»¶è¿Ÿå›è¡¥(å‡€å€¼å›è½1.5-2%åè§¦å‘ï¼Œå¼ºè¶‹åŠ¿60%/ä¸­æ€§35%ï¼Œ15å¤©çª—å£)</b> Â· <b style="color:#4f46e5;">è¶‹åŠ¿è‡ªé€‚åº”ä»“ä½(å¼ºè¶‹åŠ¿ä¹°å…¥Ã—1.4/å¼±è¶‹åŠ¿Ã—0.8)</b></span>
                                </div>
                                <div style="display:flex;align-items:baseline;gap:6px;">
                                    <span style="display:inline-block;background:#fee2e2;color:#dc2626;font-size:9px;font-weight:600;padding:1px 5px;border-radius:3px;flex-shrink:0;">å–å‡º</span>
                                    <span>å†²é«˜æ­¢ç›ˆ(P2) â‰¥${sp.take_profit_trigger||'--'}% Â· æ…¢æ¶¨æ­¢ç›ˆ(P2) è¯„åˆ†â‰¥54(çª„åŒ–çª—å£) Â· å›æ’¤æ­¢ç›ˆ(P2.2) å³°å€¼å›æ’¤â‰¥${sp.trail_dd||'1.8'}% Â· <b style="color:#4f46e5;">æ‰­äºè¯„åˆ†åŒ–(nz_bonus=min(12,æµ®ç›ˆÃ—2)ï¼Œèµ°ç»Ÿä¸€è¯„åˆ†é—¨æ§›)</b> Â· è¶‹å¼±(P3) æŒ‰ç›ˆåˆ©åˆ†çº§å‡ä»“(è–„åˆ©70%/ä¸­åˆ©50%/åšåˆ©30%) Â· æ­¢æŸ(P1) â‰¤${sp.stop_loss_base||'--'}%âˆ’è´¹ç‡ Â· çŸ­æœŸæ·±äºâ‰¤-6%å®‰å…¨ç½‘å‡30% Â· å›è¡¥ä»“ä½L2ä¿æŠ¤æœŸ10å¤©</span>
                                </div>
                                <div style="display:flex;align-items:baseline;gap:6px;">
                                    <span style="display:inline-block;background:#fef3c7;color:#92400e;font-size:9px;font-weight:600;padding:1px 5px;border-radius:3px;flex-shrink:0;">é£æ§</span>
                                    <span>ç¾éš¾é˜€ â‰¤${sp.disaster_loss_threshold||'-9'}%(æç«¯äºæŸå–50%/æš´è·Œå–30%) Â· è¡¥ä»“ç¦å…¥(10æ—¥â‰¤-10%+è¿è·Œâ‰¥5 æˆ– å›æ’¤â‰¥15%+æ³¢åŠ¨â‰¥2.5%) Â· è¡¥ä»“èŠ‚å¥é˜€(é—´éš”â‰¥2äº¤æ˜“æ—¥,æ€¥è·Œå¯ç¼©è‡³2æ—¥) Â· FIFOç©¿é€äºæŸ>50å…ƒè‡ªåŠ¨æš‚ç¼“ Â· æ€»ä»“ä½é£æ§(ç¾éš¾ä¿åº•/æ—¶é—´è±å…/è¶‹åŠ¿ç¡®è®¤ä¸‰å±‚) Â· è¶‹åŠ¿ç¡®è®¤å‡ä»“(è¿è·Œâ‰¥6å¤©+10æ—¥â‰¤-10%åŒç¡®è®¤ï¼Œæµ…äºâ‰¤-6%ä¸å‡) Â· L3åˆ†çº§å‡ä»“(æ–°ä»“&lt;25å¤©+éæš´è·Œå‡70%) Â· <b style="color:#4f46e5;">è¶‹åŠ¿è‡ªé€‚åº”ä»“ä½(å¼ºè¶‹åŠ¿ä¸Šé™Ã—1.6/å¼±è¶‹åŠ¿Ã—0.7)</b> Â· åŠ¨æ€é˜ˆå€¼ ${sp.risk_multiplier != null ? sp.risk_multiplier+'Ã—' : '1.0Ã—'} Â· çµæ•åº¦ ${sp.vol_sensitivity != null ? sp.vol_sensitivity.toFixed(2)+'Ã—' : '1.0Ã—'}(${sp.vol_sensitivity_source === 'manual' ? 'æ‰‹åŠ¨' : sp.vol_sensitivity_source === 'auto' ? 'è‡ªåŠ¨' : 'é»˜è®¤'})</span>
                                </div>
                            </div>
                        </div>`;
                        if (ma.decision_note) {
                            html += `<div style="margin:2px 0 2px;padding:4px 10px;background:#eff6ff;border:1px solid #bfdbfe;border-radius:4px;font-size:10px;color:#1e40af;line-height:1.5;">
                                ${ma.decision_note}
                            </div>`;
                        }
                        html += `</div>`;
                    }

                    // æŒä»“æ±‡æ€»
                    if (hasPos) {
                        const totalCost = holdingBatches.reduce((s, b) => s + b.amount, 0);
                        const totalShares = holdingBatches.reduce((s, b) => s + b.shares, 0);
                        const totalOriginal = holdingBatches.reduce((s, b) => s + (b.original_amount || b.amount), 0);
                        const maxPos = fundPos.max_position || 5000;
                        const suppCount = fundPos.supplement_count || 0;
                        const hasSold = totalOriginal - totalCost > 0.01;
                        const feeSchedule = fundPos.fee_schedule || null;
                        const feeDisplay = feeSchedule && feeSchedule.length > 0
                            ? feeSchedule.map(s => s.days ? `<${s.days}å¤©${s.rate}%` : `${s.rate}%`).join(' / ')
                            : 'é»˜è®¤';
                        window._feeCache = window._feeCache || {};
                        window._feeCache[code] = feeSchedule;
                        // v5.2: ä½¿ç”¨ market_valueï¼ˆä»½é¢Ã—å‡€å€¼ï¼‰å±•ç¤ºæŒä»“é‡‘é¢ï¼Œä¸æ”¯ä»˜å®ä¸€è‡´
                        const marketValue = ma && ma.market_value != null ? ma.market_value : null;
                        const displayAmount = marketValue != null ? marketValue : totalCost;
                        const unrealizedPnl = ma && ma.unrealized_pnl != null ? ma.unrealized_pnl : null;
                        const unrealizedPnlPct = ma && ma.unrealized_pnl_pct != null ? ma.unrealized_pnl_pct : null;
                        const cumulativePnl = ma && ma.cumulative_pnl != null ? ma.cumulative_pnl : null;
                        const realizedPnl = ma && ma.realized_pnl != null ? ma.realized_pnl : 0;

                        // ç›ˆäºæ˜¾ç¤º
                        let pnlHtml = '';
                        if (unrealizedPnl != null) {
                            const pnlColor = unrealizedPnl >= 0 ? '#dc2626' : '#16a34a';
                            const pnlSign = unrealizedPnl >= 0 ? '+' : '';
                            pnlHtml = `<div class="item"><span class="label">æµ®åŠ¨ç›ˆäº:</span><span class="value" style="color:${pnlColor};font-weight:700;">${pnlSign}Â¥${unrealizedPnl.toFixed(2)}${unrealizedPnlPct != null ? `(${pnlSign}${unrealizedPnlPct}%)` : ''}</span></div>`;
                        }
                        let cumPnlHtml = '';
                        if (cumulativePnl != null && realizedPnl !== 0) {
                            const cumColor = cumulativePnl >= 0 ? '#dc2626' : '#16a34a';
                            const cumSign = cumulativePnl >= 0 ? '+' : '';
                            cumPnlHtml = `<div class="item"><span class="label">ç´¯è®¡ç›ˆäº:</span><span class="value" style="color:${cumColor};">${cumSign}Â¥${cumulativePnl.toFixed(2)}</span></div>`;
                        }
                        // æˆæœ¬æ ‡æ³¨ï¼šä»…åœ¨ market_value å¯ç”¨æ—¶æ˜¾ç¤ºæˆæœ¬å¯¹æ¯”
                        const costNote = marketValue != null ? `<span style="color:#9ca3af;font-size:9px;margin-left:2px;">(æˆæœ¬Â¥${totalCost.toFixed(0)}${hasSold ? `/æŠ•å…¥Â¥${totalOriginal.toFixed(0)}` : ''})</span>` : (hasSold ? `<span style="color:#9ca3af;font-size:9px;margin-left:2px;">(æŠ•å…¥Â¥${totalOriginal.toFixed(0)})</span>` : '');
                        html += `<div class="pos-summary">
                            <div class="item"><span class="label">æŒä»“é‡‘é¢:</span><span class="value">Â¥${displayAmount.toFixed(2)}${costNote}</span></div>
                            ${pnlHtml}
                            ${cumPnlHtml}
                            <div class="item"><span class="label">ä»½é¢:</span><span class="value">${totalShares.toFixed(2)}</span></div>
                            <div class="item"><span class="label">æ‰¹æ¬¡:</span><span class="value">${holdingBatches.length}ç¬”</span></div>
                            ${suppCount > 0 ? `<div class="item"><span class="label">è¡¥ä»“:</span><span class="value" style="color:#d97706;">${suppCount}/${sigMap[code]?.market_analysis?.strategy_params?.supplement_max_count || 3}æ¬¡</span></div>` : ''}
                            <div class="item"><span class="label">ä¸Šé™:</span><span class="value" style="cursor:pointer;border-bottom:1px dashed #9ca3af;" onclick="editMaxPosition('${code}',${maxPos})" title="ç‚¹å‡»ä¿®æ”¹ä¸Šé™">Â¥${maxPos}</span></div>
                            <div class="item"><span class="label">è´¹ç‡:</span><span class="value" style="cursor:pointer;border-bottom:1px dashed #9ca3af;" onclick="editFeeSchedule('${code}')" title="ç‚¹å‡»ä¿®æ”¹è´¹ç‡">${feeDisplay}</span></div>
                        </div>`;
                    }

                    // æ‰¹æ¬¡è¡¨æ ¼
                    const sellRecords = (fundPos?.sell_records || [])
                        .sort((a, b) => (b.sell_date || '').localeCompare(a.sell_date || ''));
                    if (hasPos || sellRecords.length > 0) {
                        html += `<div class="pos-batches"><table>
                            <colgroup>
                                <col style="width:17%"><col style="width:15%"><col style="width:15%"><col style="width:13%"><col style="width:12%"><col style="width:10%"><col style="width:18%">
                            </colgroup>
                            <thead><tr>
                                <th>æ‰¹æ¬¡</th><th>æ—¥æœŸ</th><th>é‡‘é¢</th><th>å‡€å€¼</th><th>ä»½é¢</th><th>å¤‡æ³¨</th><th style="text-align:right;">æ“ä½œ</th>
                            </tr></thead><tbody>`;
                        for (const b of holdingBatches) {
                            let amountDisplay = `Â¥${b.amount.toFixed(2)}`;
                            if (b.original_amount && Math.abs(b.original_amount - b.amount) > 0.01) {
                                amountDisplay = `Â¥${b.amount.toFixed(2)} <span style="color:#9ca3af;font-size:9px;text-decoration:line-through;">Â¥${b.original_amount.toFixed(0)}</span>`;
                            }
                            html += `<tr>
                                <td style="font-family:monospace;font-size:10px;">${b.id}</td>
                                <td>${b.buy_date}</td>
                                <td>${amountDisplay}</td>
                                <td>${b.nav.toFixed(4)}</td>
                                <td>${b.shares.toFixed(2)}</td>
                                <td style="color:#9ca3af;">${b.note || ''}</td>
                                <td style="text-align:right;">
                                    <button onclick="showSellModal('${code}','${b.id}',${b.nav})" title="å–å‡º" style="color:#ef4444;background:none;border:none;cursor:pointer;font-size:12px;">å–</button>
                                    <button onclick="deleteBatch('${code}','${b.id}')" title="åˆ é™¤" style="color:#d1d5db;background:none;border:none;cursor:pointer;font-size:12px;">Ã—</button>
                                </td>
                            </tr>`;
                        }
                        if (sellRecords.length > 0) {
                            html += `<tr><td colspan="7" style="padding:6px 6px 2px;border-top:1px dashed #e5e7eb;"></td></tr>`;
                            html += `<tr style="background:#f8fafc;">
                                <th style="text-align:left;padding:4px 6px;color:#9ca3af;font-weight:500;font-size:10px;">æ¥æºæ‰¹æ¬¡</th>
                                <th style="text-align:left;padding:4px 6px;color:#9ca3af;font-weight:500;font-size:10px;">å–å‡ºæ—¥</th>
                                <th style="text-align:left;padding:4px 6px;color:#9ca3af;font-weight:500;font-size:10px;">ä¹°å…¥å‡€å€¼</th>
                                <th style="text-align:left;padding:4px 6px;color:#9ca3af;font-weight:500;font-size:10px;">å–å‡ºå‡€å€¼</th>
                                <th style="text-align:left;padding:4px 6px;color:#9ca3af;font-weight:500;font-size:10px;">ä»½é¢</th>
                                <th style="text-align:left;padding:4px 6px;color:#9ca3af;font-weight:500;font-size:10px;">æŒæœ‰å¤©æ•°</th>
                                <th style="text-align:right;padding:4px 6px;color:#9ca3af;font-weight:500;font-size:10px;">ç›ˆäº</th>
                            </tr>`;
                            for (const sr of sellRecords) {
                                let navCell = '';
                                let profitCell = '';
                                if (sr.sell_nav) {
                                    navCell = sr.sell_nav.toFixed(4);
                                    const pColor = (sr.profit_pct || 0) >= 0 ? '#dc2626' : '#16a34a';
                                    profitCell = `<span style="color:${pColor};font-weight:600;font-size:10px;">${sr.profit_pct >= 0 ? '+' : ''}${sr.profit_pct}%</span>`;
                                } else {
                                    navCell = `<button onclick="promptSellNav('${code}','${sr.id}')" style="background:none;border:1px solid #f59e0b;color:#f59e0b;font-size:9px;padding:1px 6px;border-radius:3px;cursor:pointer;">è¡¥å½•</button>`;
                                    profitCell = `<span style="color:#f59e0b;font-size:9px;">å¾…ç¡®è®¤</span>`;
                                }
                                html += `<tr style="color:#9ca3af;">
                                    <td style="font-family:monospace;font-size:9px;">${sr.batch_id}</td>
                                    <td>${sr.sell_date}</td>
                                    <td>${sr.buy_nav.toFixed(4)}</td>
                                    <td>${navCell}</td>
                                    <td>${sr.sell_shares.toFixed(2)}</td>
                                    <td>${sr.hold_days}å¤©</td>
                                    <td style="text-align:right;">${profitCell} <button onclick="deleteSellRecord('${code}','${sr.id}')" title="åˆ é™¤å–å‡ºè®°å½•" style="color:#d1d5db;background:none;border:none;cursor:pointer;font-size:11px;margin-left:2px;">Ã—</button></td>
                                </tr>`;
                            }
                        }
                        html += '</tbody></table></div>';
                    }
                    html += `<div class="pos-actions">
                        <button class="buy-btn" onclick="showBuyModal('${code}')">å½•å…¥ä¹°å…¥</button>`;
                    const fifoP = sig.fifo_sell_plan;
                    if (fifoP && fifoP.steps && fifoP.steps.length > 0) {
                        html += `<button class="sell-btn" onclick="showSellFifoModal('${code}', ${fifoP.total_shares})">æ‰§è¡Œå–å‡º(${fifoP.total_shares}ä»½)</button>`;
                    } else {
                        const sellSignals = (sig.all_signals || [sig]).filter(s => s.action === 'sell' && s.target_batch_id);
                        for (const ss of sellSignals) {
                            html += `<button class="sell-btn" onclick="showSellFifoModal('${code}', ${ss.sell_shares || 0})">æ‰§è¡Œ${ss.signal_name}(${ss.sell_shares}ä»½)</button>`;
                        }
                    }
                    html += `</div>`;
                    html += '</div>';
                    return html;
                }
        }

        // ============ ä¹°å…¥/å–å‡ºæ“ä½œ ============
        function showQuickBuyModal() {
            const code = prompt('è¯·è¾“å…¥6ä½åŸºé‡‘ä»£ç ï¼š');
            if (code && /^\d{6}$/.test(code.trim())) {
                showBuyModal(code.trim());
            }
        }

        function quickAddPosition() {
            const input = document.getElementById('quickAddCode');
            const code = input.value.trim();
            if (/^\d{6}$/.test(code)) {
                showBuyModal(code);
                input.value = '';
            } else {
                showStatus('è¯·è¾“å…¥6ä½åŸºé‡‘ä»£ç ', 'error');
            }
        }

        function showAddInstanceModal() {
            document.getElementById('instanceFundCode').value = '';
            document.getElementById('instanceOwner').value = '';
            document.getElementById('addInstanceModal').classList.add('show');
            document.getElementById('instanceFundCode').focus();
        }

        function submitAddInstance() {
            const code = document.getElementById('instanceFundCode').value.trim();
            const owner = document.getElementById('instanceOwner').value.trim();

            if (!/^\d{6}$/.test(code)) {
                showStatus('è¯·è¾“å…¥6ä½åŸºé‡‘ä»£ç ', 'error');
                return;
            }
            if (!owner) {
                showStatus('è¯·è¾“å…¥æŒä»“äºº/æ ‡ç­¾', 'error');
                return;
            }
            if (owner.includes('__') || /['"<>&\/\\]/.test(owner)) {
                showStatus('æ ‡ç­¾ä¸èƒ½åŒ…å« __ æˆ–ç‰¹æ®Šç¬¦å·', 'error');
                return;
            }

            closeModal('addInstanceModal');
            // æ‰“å¼€ä¹°å…¥å¼¹çª—ï¼Œä¼ å…¥ owner
            showBuyModal(code, owner);
        }

        function showSetOwnerModal(fundKey) {
            const realCode = fundKey.includes('__') ? fundKey.split('__')[0] : fundKey;
            const currentOwner = fundKey.includes('__') ? fundKey.split('__')[1] : '';
            const name = valuations[realCode]?.fund_name || realCode;

            const newOwner = prompt(
                `ä¸º ${realCode} ${name} è®¾ç½®æŒä»“äººæ ‡ç­¾\nï¼ˆç•™ç©ºåˆ™å»é™¤æ ‡ç­¾ï¼Œå½“å‰: ${currentOwner || 'æ— '}ï¼‰`,
                currentOwner
            );
            if (newOwner === null) return; // ç”¨æˆ·å–æ¶ˆ
            const trimmed = newOwner.trim();
            if (trimmed.includes('__') || /['"<>&\/\\]/.test(trimmed)) {
                showStatus('æ ‡ç­¾ä¸èƒ½åŒ…å« __ æˆ–ç‰¹æ®Šç¬¦å·', 'error');
                return;
            }
            submitSetOwner(fundKey, trimmed);
        }

        async function submitSetOwner(oldKey, newOwner) {
            try {
                const res = await fetch(`${API_BASE}/v1/position/${encodeURIComponent(oldKey)}/rename`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ new_owner: newOwner })
                });
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || 'è®¾ç½®å¤±è´¥');
                }
                const data = await res.json();
                // åŒæ­¥æ›´æ–°å‰ç«¯ localStorage ä¸­çš„åˆ†ç»„æ˜ å°„
                const groupData = loadStrategyGroups();
                const oldGroupId = groupData.fund_group_map[oldKey];
                if (oldGroupId && data.new_key !== oldKey) {
                    // è¿ç§»åˆ†ç»„æ˜ å°„
                    for (const grp of groupData.groups) {
                        grp.fund_codes = grp.fund_codes.map(c => c === oldKey ? data.new_key : c);
                    }
                    groupData.fund_group_map[data.new_key] = oldGroupId;
                    delete groupData.fund_group_map[oldKey];
                    saveStrategyGroups(groupData);
                }
                showStatus(`æ ‡ç­¾å·²æ›´æ–°: ${data.new_key}`, 'success');
                loadStrategyPanel();
            } catch (e) {
                showStatus('è®¾ç½®æ ‡ç­¾å¤±è´¥: ' + e.message, 'error');
            }
        }

        function showBuyModal(fundCode, owner) {
            // fundCode å¯èƒ½æ˜¯å¤åˆé”® "017193__è€å…¬"ï¼Œä¹Ÿå¯èƒ½æ˜¯çº¯ä»£ç  "017193"
            let realCode = fundCode;
            let ownerTag = owner || '';
            if (fundCode.includes('__')) {
                const parts = fundCode.split('__');
                realCode = parts[0];
                ownerTag = parts[1] || '';
            }
            document.getElementById('buyFundCode').value = realCode;
            document.getElementById('buyOwner').value = ownerTag;
            document.getElementById('buyAmount').value = '';
            document.getElementById('buyNav').value = '';
            document.getElementById('buyNote').value = '';
            document.getElementById('buySupplement').checked = false;
            // é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
            document.getElementById('buyDate').value = new Date().toISOString().slice(0, 10);

            const val = valuations[realCode];
            const name = val?.fund_name || realCode;
            const ownerLabel = ownerTag ? ` [${ownerTag}]` : '';
            document.getElementById('buyModalTitle').textContent = `å½•å…¥ä¹°å…¥ Â· ${name}${ownerLabel}`;

            if (val?.recent_changes?.length > 0) {
                const latest = val.recent_changes[0];
                document.getElementById('buyNavHint').textContent =
                    `æœ€è¿‘ç¡®è®¤å‡€å€¼å‚è€ƒ: ${latest.date}ï¼Œåœ¨æ”¯ä»˜å®äº¤æ˜“è®°å½•ä¸­æŸ¥çœ‹å®é™…å€¼`;
            } else {
                document.getElementById('buyNavHint').textContent = 'åœ¨æ”¯ä»˜å®â†’æŒä»“â†’äº¤æ˜“è®°å½•ä¸­æŸ¥çœ‹ã€Œç¡®è®¤å‡€å€¼ã€';
            }

            document.getElementById('buyModal').classList.add('show');
            document.getElementById('buyAmount').focus();
        }

        async function submitBuy() {
            const code = document.getElementById('buyFundCode').value;
            const owner = document.getElementById('buyOwner').value;
            const buyDate = document.getElementById('buyDate').value;
            const amount = parseFloat(document.getElementById('buyAmount').value);
            const nav = parseFloat(document.getElementById('buyNav').value);
            const note = document.getElementById('buyNote').value.trim();

            if (!buyDate) { showStatus('è¯·é€‰æ‹©ä¹°å…¥æ—¥æœŸ', 'error'); return; }
            if (!amount || amount <= 0) { showStatus('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢', 'error'); return; }
            if (!nav || nav <= 0) { showStatus('è¯·è¾“å…¥æœ‰æ•ˆç¡®è®¤å‡€å€¼', 'error'); return; }

            try {
                const isSupplement = document.getElementById('buySupplement').checked;
                const res = await fetch(`${API_BASE}/v1/position/${encodeURIComponent(code)}/buy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount, nav, note, buy_date: buyDate, is_supplement: isSupplement, owner: owner })
                });
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || 'ä¹°å…¥å¤±è´¥');
                }
                const data = await res.json();
                const ownerLabel = owner ? ` [${owner}]` : '';
                showStatus(`ä¹°å…¥æˆåŠŸ: ${code}${ownerLabel} Â· ${data.batch?.id}`, 'success');
                closeModal('buyModal');
                loadStrategyPanel();  // åˆ·æ–°ç­–ç•¥é¢æ¿
            } catch (e) {
                showStatus('ä¹°å…¥å¤±è´¥: ' + e.message, 'error');
            }
        }

        // ============ ç­–ç•¥è¯´æ˜æŠ˜å  ============
        function toggleStrategyInfo(fundCode) {
            const el = document.getElementById(`strategy-info-${fundCode}`);
            if (el) el.classList.toggle('show');
        }

        // ============ å–å‡ºæ“ä½œ ============
        let _sellBatchesCache = [];  // ç¼“å­˜å½“å‰åŸºé‡‘çš„æ‰¹æ¬¡åˆ—è¡¨

        function showSellFifoModal(fundCode, suggestedShares) {
            document.getElementById('sellFundCode').value = fundCode;
            document.getElementById('sellMode').value = 'fifo';
            document.getElementById('sellShares').value = suggestedShares ? suggestedShares.toFixed(2) : '';
            document.getElementById('sellNav').value = '';
            document.getElementById('sellDate').value = new Date().toISOString().slice(0, 10);

            const realCode = fundCode.includes('__') ? fundCode.split('__')[0] : fundCode;
            const ownerTag = fundCode.includes('__') ? fundCode.split('__')[1] : '';
            const name = valuations[realCode]?.fund_name || realCode;
            const ownerLabel = ownerTag ? ` [${ownerTag}]` : '';
            document.getElementById('sellModalTitle').textContent = `å½•å…¥å–å‡º Â· ${name}${ownerLabel}`;

            // éšè—æ‰¹æ¬¡é€‰æ‹©ï¼Œæ˜¾ç¤º FIFO è¯´æ˜
            document.getElementById('sellBatchSelectWrap').style.display = 'none';
            document.getElementById('sellFifoInfo').style.display = 'block';

            // åŠ è½½æ‰¹æ¬¡ä¿¡æ¯ç”¨äº FIFO é¢„è§ˆ
            fetch(`${API_BASE}/v1/position/${encodeURIComponent(fundCode)}`)
                .then(r => r.json())
                .then(data => {
                    const batches = (data.batches || []).filter(b => b.status === 'holding');
                    batches.sort((a, b) => a.buy_date.localeCompare(b.buy_date));
                    _sellBatchesCache = batches;

                    const totalShares = batches.reduce((s, b) => s + b.shares, 0);
                    document.getElementById('sellSharesHint').textContent =
                        `æ€»æŒæœ‰ ${totalShares.toFixed(2)} ä»½ï¼ˆ${batches.length}ä¸ªæ‰¹æ¬¡ï¼‰ï¼Œå…¨éƒ¨å–å‡ºå¡« ${totalShares.toFixed(2)}`;

                    // é¢„è§ˆ FIFO æ‹†è§£
                    let stepsHtml = '';
                    let remaining = suggestedShares || 0;
                    for (const b of batches) {
                        if (remaining <= 0.005) break;
                        const sellAmt = Math.min(remaining, b.shares);
                        const holdDays = Math.floor((new Date() - new Date(b.buy_date)) / 86400000);
                        stepsHtml += `<div style="padding:1px 0;">${b.id} Â· ${b.buy_date} Â· æŒæœ‰${holdDays}å¤© â†’ å–å‡º ${sellAmt.toFixed(2)}ä»½${Math.abs(sellAmt - b.shares) < 0.01 ? '(å…¨éƒ¨)' : `(å‰©${(b.shares-sellAmt).toFixed(2)})`}</div>`;
                        remaining -= sellAmt;
                    }
                    document.getElementById('sellFifoSteps').innerHTML = stepsHtml;
                })
                .catch(() => {
                    document.getElementById('sellSharesHint').textContent = 'åŠ è½½æ‰¹æ¬¡ä¿¡æ¯å¤±è´¥';
                });

            document.getElementById('sellModal').classList.add('show');
        }

        function showSellModal(fundCode, preselectedBatchId, buyNav) {
            document.getElementById('sellFundCode').value = fundCode;
            document.getElementById('sellMode').value = 'batch';
            document.getElementById('sellShares').value = '';
            document.getElementById('sellNav').value = '';
            document.getElementById('sellDate').value = new Date().toISOString().slice(0, 10);

            // æ˜¾ç¤ºæ‰¹æ¬¡é€‰æ‹©ï¼Œéšè— FIFO è¯´æ˜
            document.getElementById('sellBatchSelectWrap').style.display = 'block';
            document.getElementById('sellFifoInfo').style.display = 'none';

            const realCode2 = fundCode.includes('__') ? fundCode.split('__')[0] : fundCode;
            const ownerTag2 = fundCode.includes('__') ? fundCode.split('__')[1] : '';
            const name = valuations[realCode2]?.fund_name || realCode2;
            const ownerLabel2 = ownerTag2 ? ` [${ownerTag2}]` : '';
            document.getElementById('sellModalTitle').textContent = `å½•å…¥å–å‡º Â· ${name}${ownerLabel2}`;

            // åŠ è½½è¯¥åŸºé‡‘çš„ holding æ‰¹æ¬¡åˆ°ä¸‹æ‹‰æ¡†
            const select = document.getElementById('sellBatchSelect');
            select.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
            _sellBatchesCache = [];

            fetch(`${API_BASE}/v1/position/${encodeURIComponent(fundCode)}`)
                .then(r => r.json())
                .then(data => {
                    const batches = (data.batches || []).filter(b => b.status === 'holding');
                    _sellBatchesCache = batches;
                    let opts = '';
                    if (batches.length === 0) {
                        opts = '<option value="">æ— å¯å–å‡ºæ‰¹æ¬¡</option>';
                    } else {
                        opts = '<option value="">è¯·é€‰æ‹©æ‰¹æ¬¡...</option>';
                        for (const b of batches) {
                            const sel = b.id === preselectedBatchId ? ' selected' : '';
                            opts += `<option value="${b.id}"${sel}>${b.id} Â· ${b.buy_date} Â· ${b.shares.toFixed(2)}ä»½ Â· å‡€å€¼${b.nav.toFixed(4)}${b.note ? ' Â· ' + b.note : ''}</option>`;
                        }
                    }
                    select.innerHTML = opts;
                    onSellBatchChange();
                })
                .catch(() => {
                    select.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
                });

            document.getElementById('sellModal').classList.add('show');
        }

        function onSellBatchChange() {
            const batchId = document.getElementById('sellBatchSelect').value;
            const hint = document.getElementById('sellBatchHint');
            const sharesHint = document.getElementById('sellSharesHint');
            if (!batchId) {
                hint.textContent = '';
                sharesHint.textContent = '';
                return;
            }
            const batch = _sellBatchesCache.find(b => b.id === batchId);
            if (batch) {
                const buyDate = new Date(batch.buy_date);
                const today = new Date();
                const holdDays = Math.floor((today - buyDate) / 86400000);
                hint.textContent = `ä¹°å…¥ Â¥${batch.amount.toFixed(2)}ï¼Œå‡€å€¼ ${batch.nav.toFixed(4)}ï¼ŒæŒæœ‰${holdDays}å¤©`;
                sharesHint.textContent = `è¯¥æ‰¹æ¬¡æŒæœ‰ ${batch.shares.toFixed(2)} ä»½ï¼Œå…¨éƒ¨å–å‡ºå¡« ${batch.shares.toFixed(2)}`;
                // é¢„å¡«å…¨éƒ¨ä»½é¢
                document.getElementById('sellShares').value = batch.shares.toFixed(2);
            }
        }

        async function submitSell() {
            const code = document.getElementById('sellFundCode').value;
            const mode = document.getElementById('sellMode').value;
            const sellShares = parseFloat(document.getElementById('sellShares').value);
            const sellNav = parseFloat(document.getElementById('sellNav').value) || null;
            const sellDate = document.getElementById('sellDate').value || null;

            if (!sellShares || sellShares <= 0) { showStatus('è¯·è¾“å…¥æœ‰æ•ˆå–å‡ºä»½é¢', 'error'); return; }

            try {
                let res, data, statusMsg;

                if (mode === 'fifo') {
                    // FIFO æ¨¡å¼ï¼šè°ƒç”¨æ–°æ¥å£ï¼Œè‡ªåŠ¨æŒ‰å…ˆè¿›å…ˆå‡ºæ‹†åˆ†
                    const body = { total_sell_shares: sellShares };
                    if (sellNav) body.sell_nav = sellNav;
                    if (sellDate) body.sell_date = sellDate;

                    res = await fetch(`${API_BASE}/v1/position/${encodeURIComponent(code)}/sell-fifo`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                    if (!res.ok) {
                        const err = await res.json();
                        throw new Error(err.detail || 'å–å‡ºå¤±è´¥');
                    }
                    data = await res.json();
                    statusMsg = `FIFOå–å‡ºæˆåŠŸ: ${data.total_sell_shares}ä»½ï¼ˆæ¶‰åŠ${data.batch_count}ä¸ªæ‰¹æ¬¡ï¼‰`;
                    if (data.nav_pending) {
                        statusMsg += ' Â· å‡€å€¼å¾…ç¡®è®¤';
                    } else if (data.total_profit !== null) {
                        const profitStr = data.total_profit >= 0 ? `+Â¥${data.total_profit.toFixed(2)}` : `-Â¥${Math.abs(data.total_profit).toFixed(2)}`;
                        statusMsg += ` Â· ${profitStr}`;
                    }
                } else {
                    // å•æ‰¹æ¬¡æ¨¡å¼ï¼ˆå…œåº• / æ‰‹åŠ¨é€‰æ‰¹æ¬¡ï¼‰
                    const batchId = document.getElementById('sellBatchSelect').value;
                    if (!batchId) { showStatus('è¯·é€‰æ‹©å–å‡ºæ‰¹æ¬¡', 'error'); return; }

                    const body = { batch_id: batchId, sell_shares: sellShares };
                    if (sellNav) body.sell_nav = sellNav;
                    if (sellDate) body.sell_date = sellDate;

                    res = await fetch(`${API_BASE}/v1/position/${encodeURIComponent(code)}/sell`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                    if (!res.ok) {
                        const err = await res.json();
                        throw new Error(err.detail || 'å–å‡ºå¤±è´¥');
                    }
                    data = await res.json();
                    statusMsg = `å–å‡ºæˆåŠŸ: ${data.sell_shares}ä»½ï¼ˆæŒæœ‰${data.hold_days}å¤©ï¼Œè´¹ç‡${data.sell_fee_rate}%ï¼‰`;
                    if (data.nav_pending) {
                        statusMsg += ' Â· å‡€å€¼å¾…ç¡®è®¤';
                    } else {
                        const profitStr = data.profit >= 0 ? `+Â¥${data.profit.toFixed(2)}` : `-Â¥${Math.abs(data.profit).toFixed(2)}`;
                        statusMsg += ` Â· ${profitStr}`;
                    }
                }

                showStatus(statusMsg, 'success');
                closeModal('sellModal');
                loadStrategyPanel();
            } catch (e) {
                showStatus('å–å‡ºå¤±è´¥: ' + e.message, 'error');
            }
        }

        async function deleteBatch(fundCode, batchId) {
            if (!confirm(`ç¡®å®šåˆ é™¤æ‰¹æ¬¡ ${batchId}ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) return;
            try {
                const res = await fetch(`${API_BASE}/v1/position/${encodeURIComponent(fundCode)}/batch/${batchId}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('åˆ é™¤å¤±è´¥');
                showStatus(`å·²åˆ é™¤ ${batchId}`, 'success');
                loadStrategyPanel();
            } catch (e) {
                showStatus('åˆ é™¤å¤±è´¥: ' + e.message, 'error');
            }
        }

        async function deleteSellRecord(fundCode, sellRecordId) {
            if (!confirm(`ç¡®å®šåˆ é™¤å–å‡ºè®°å½• ${sellRecordId}ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) return;
            try {
                const res = await fetch(`${API_BASE}/v1/position/${encodeURIComponent(fundCode)}/sell-record/${sellRecordId}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('åˆ é™¤å¤±è´¥');
                showStatus(`å·²åˆ é™¤å–å‡ºè®°å½• ${sellRecordId}`, 'success');
                loadStrategyPanel();
            } catch (e) {
                showStatus('åˆ é™¤å¤±è´¥: ' + e.message, 'error');
            }
        }

        async function promptSellNav(fundCode, sellRecordId) {
            const navStr = prompt('è¯·è¾“å…¥å–å‡ºç¡®è®¤å‡€å€¼ï¼ˆåœ¨æ”¯ä»˜å®â†’äº¤æ˜“è®°å½•â†’å–å‡ºè¯¦æƒ…ä¸­æŸ¥çœ‹ï¼‰:');
            if (!navStr) return;
            const nav = parseFloat(navStr);
            if (!nav || nav <= 0) { showStatus('è¯·è¾“å…¥æœ‰æ•ˆå‡€å€¼', 'error'); return; }
            try {
                const res = await fetch(`${API_BASE}/v1/position/${encodeURIComponent(fundCode)}/sell-nav`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sell_record_id: sellRecordId, sell_nav: nav })
                });
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || 'è¡¥å½•å¤±è´¥');
                }
                const data = await res.json();
                const r = data.record;
                const profitStr = r.profit >= 0 ? `+Â¥${r.profit.toFixed(2)}` : `-Â¥${Math.abs(r.profit).toFixed(2)}`;
                showStatus(`å‡€å€¼å·²è¡¥å½•: ${r.sell_nav.toFixed(4)} Â· ${profitStr} (${r.profit_pct}%)`, 'success');
                loadStrategyPanel();
            } catch (e) {
                showStatus('è¡¥å½•å¤±è´¥: ' + e.message, 'error');
            }
        }

        async function editMaxPosition(fundCode, currentMax) {
            const input = prompt(`ä¿®æ”¹ ${fundCode} çš„æŒä»“ä¸Šé™ï¼ˆå½“å‰ Â¥${currentMax}ï¼‰ï¼š`, currentMax);
            if (!input) return;
            const newMax = parseInt(input);
            if (!newMax || newMax <= 0) { showStatus('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢', 'error'); return; }
            try {
                const res = await fetch(`${API_BASE}/v1/position/${encodeURIComponent(fundCode)}/config`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ max_position: newMax })
                });
                if (!res.ok) throw new Error('æ›´æ–°å¤±è´¥');
                showStatus(`ä¸Šé™å·²æ›´æ–°ä¸º Â¥${newMax}`, 'success');
                loadStrategyPanel();
            } catch (e) {
                showStatus('æ›´æ–°å¤±è´¥: ' + e.message, 'error');
            }
        }

        async function editFeeSchedule(fundCode) {
            const currentSchedule = (window._feeCache && window._feeCache[fundCode]) || null;
            // å½“å‰è´¹ç‡æ˜¾ç¤º
            let desc = 'å½“å‰è´¹ç‡: ';
            if (currentSchedule && currentSchedule.length > 0) {
                desc += currentSchedule.map(s => s.days ? `<${s.days}å¤©=${s.rate}%` : `å…œåº•=${s.rate}%`).join(', ');
            } else {
                desc += 'ä½¿ç”¨é»˜è®¤(<7å¤©=1.5%, <30å¤©=0.5%, ä¹‹å=0%)';
            }
            const input = prompt(
                `${desc}\n\nè¯·è¾“å…¥æ–°è´¹ç‡ï¼ˆæ ¼å¼: å¤©æ•°:è´¹ç‡%, å¤šæ¡£ç”¨é€—å·åˆ†éš”ï¼‰\nç¤ºä¾‹:\n  7:1.5,30:0.5,0:0  ï¼ˆ<7å¤©1.5%, <30å¤©0.5%, ä¹‹å0%ï¼‰\n  7:1.5,0:0          ï¼ˆ<7å¤©1.5%, ä¹‹å0%ï¼‰\n  0:0                ï¼ˆæ°¸è¿œ0%ï¼‰`,
                currentSchedule && currentSchedule.length > 0
                    ? currentSchedule.map(s => `${s.days || 0}:${s.rate}`).join(',')
                    : '7:1.5,30:0.5,0:0'
            );
            if (!input) return;

            try {
                const schedule = input.split(',').map(s => {
                    const [days, rate] = s.trim().split(':');
                    const d = parseInt(days);
                    const r = parseFloat(rate);
                    if (isNaN(r)) throw new Error(`æ— æ•ˆè´¹ç‡: ${s}`);
                    return { days: d > 0 ? d : null, rate: r };
                });
                const res = await fetch(`${API_BASE}/v1/position/${encodeURIComponent(fundCode)}/fee-schedule`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ schedule })
                });
                if (!res.ok) throw new Error('æ›´æ–°å¤±è´¥');
                showStatus(`è´¹ç‡å·²æ›´æ–°`, 'success');
                loadStrategyPanel();
            } catch (e) {
                showStatus('è´¹ç‡æ›´æ–°å¤±è´¥: ' + e.message, 'error');
            }
        }

        // ============ ç­–ç•¥åˆ†ç»„ç®¡ç†ï¼ˆlocalStorageæŒä¹…åŒ–ï¼‰ ============
        // v5.4 ä¼˜åŒ–: æ ¹æ®è§’è‰²æ ‡ç­¾(owner tag)è‡ªåŠ¨å½’ç±»åˆ†ç»„ï¼Œæ”¯æŒæ‰‹åŠ¨ç§»å…¥ç§»å‡ºè¦†ç›–
        // æ•°æ®ç»“æ„: { groups: [{id, name, fund_codes: []}], fund_group_map: {code: groupId}, overrides: {code: groupId|""} }
        const STRATEGY_GROUPS_KEY = 'ease_grid_strategy_groups';

        function loadStrategyGroups() {
            try {
                const raw = localStorage.getItem(STRATEGY_GROUPS_KEY);
                if (raw) return JSON.parse(raw);
            } catch {}
            return { groups: [], fund_group_map: {}, overrides: {} };
        }

        function saveStrategyGroups(data) {
            localStorage.setItem(STRATEGY_GROUPS_KEY, JSON.stringify(data));
        }

        /**
         * v5.4 ä¼˜åŒ–: æ ¹æ®æ‰€æœ‰åŸºé‡‘çš„è§’è‰²æ ‡ç­¾è‡ªåŠ¨åŒæ­¥åˆ†ç»„
         * - ä» fund_codes ä¸­æå– owner tag (å¦‚ 025500__è€çˆ¸ â†’ "è€çˆ¸")
         * - è‡ªåŠ¨åˆ›å»º/ç»´æŠ¤ä»¥ owner tag å‘½åçš„åˆ†ç»„
         * - æ‰‹åŠ¨è¦†ç›–(overrides)ä¼˜å…ˆï¼šç”¨æˆ·æ‰‹åŠ¨ç§»å…¥ç§»å‡ºçš„è®°å½•ä¸ä¼šè¢«è‡ªåŠ¨è¦†ç›–
         */
        function autoSyncGroupsFromOwnerTags(allFundCodes) {
            const data = loadStrategyGroups();
            if (!data.overrides) data.overrides = {};

            // 1. æ”¶é›†æ‰€æœ‰ owner tag
            const tagToFunds = {};  // tag -> [code, ...]
            const noTagFunds = [];
            for (const code of allFundCodes) {
                if (code.includes('__')) {
                    const tag = code.split('__')[1] || '';
                    if (tag) {
                        (tagToFunds[tag] = tagToFunds[tag] || []).push(code);
                        continue;
                    }
                }
                noTagFunds.push(code);
            }

            // 2. ä¸ºæ¯ä¸ª tag ç¡®ä¿å­˜åœ¨å¯¹åº”åˆ†ç»„ï¼ˆç”¨ name åŒ¹é…ï¼Œä¸é‡å¤åˆ›å»ºï¼‰
            const tagToGroupId = {};
            for (const tag of Object.keys(tagToFunds)) {
                let grp = data.groups.find(g => g.name === tag);
                if (!grp) {
                    grp = { id: 'grp_auto_' + tag, name: tag, fund_codes: [] };
                    data.groups.push(grp);
                }
                tagToGroupId[tag] = grp.id;
            }

            // 3. è‡ªåŠ¨åˆ†é…ï¼ˆoverridesä¼˜å…ˆï¼‰
            // å…ˆæ¸…ç©ºæ‰€æœ‰è‡ªåŠ¨åˆ†ç»„çš„fund_codesï¼Œé‡æ–°å¡«å……
            for (const grp of data.groups) {
                grp.fund_codes = [];
            }
            data.fund_group_map = {};

            for (const code of allFundCodes) {
                // æ‰‹åŠ¨è¦†ç›–ä¼˜å…ˆ
                if (code in data.overrides) {
                    const overrideGroupId = data.overrides[code];
                    if (overrideGroupId) {
                        const grp = data.groups.find(g => g.id === overrideGroupId);
                        if (grp) {
                            grp.fund_codes.push(code);
                            data.fund_group_map[code] = overrideGroupId;
                        }
                    }
                    // overrideGroupId === "" è¡¨ç¤ºç”¨æˆ·æ‰‹åŠ¨è®¾ä¸º"ä¸åˆ†ç»„"
                    continue;
                }

                // è‡ªåŠ¨ï¼šæŒ‰ owner tag å½’ç±»
                if (code.includes('__')) {
                    const tag = code.split('__')[1] || '';
                    const gid = tagToGroupId[tag];
                    if (gid) {
                        const grp = data.groups.find(g => g.id === gid);
                        if (grp) {
                            grp.fund_codes.push(code);
                            data.fund_group_map[code] = gid;
                        }
                        continue;
                    }
                }
                // æ— tagä¸”æ— override â†’ ä¸åˆ†ç»„
            }

            // 4. æ¸…ç†ç©ºçš„è‡ªåŠ¨åˆ†ç»„ï¼ˆä»…æ¸…ç†è‡ªåŠ¨åˆ›å»ºçš„ï¼Œä¿ç•™æ‰‹åŠ¨åˆ›å»ºçš„ï¼‰
            data.groups = data.groups.filter(g => g.fund_codes.length > 0 || !g.id.startsWith('grp_auto_'));

            saveStrategyGroups(data);
            return data;
        }

        function showGroupModal(editId) {
            const data = loadStrategyGroups();
            const existing = editId ? data.groups.find(g => g.id === editId) : null;
            document.getElementById('groupModalTitle').textContent = existing ? 'ç¼–è¾‘åˆ†ç»„' : 'æ–°å»ºåˆ†ç»„';
            document.getElementById('groupNameInput').value = existing ? existing.name : '';
            document.getElementById('groupEditId').value = editId || '';
            document.getElementById('groupModal').classList.add('show');
            document.getElementById('groupNameInput').focus();
        }

        function saveGroup() {
            const name = document.getElementById('groupNameInput').value.trim();
            if (!name) { showStatus('è¯·è¾“å…¥åˆ†ç»„åç§°', 'error'); return; }

            const data = loadStrategyGroups();
            const editId = document.getElementById('groupEditId').value;

            if (editId) {
                const grp = data.groups.find(g => g.id === editId);
                if (grp) grp.name = name;
            } else {
                const id = 'grp_' + Date.now();
                data.groups.push({ id, name, fund_codes: [] });
            }
            saveStrategyGroups(data);
            closeModal('groupModal');
            loadStrategyPanel();
        }

        function deleteGroup(groupId) {
            if (!confirm('ç¡®å®šåˆ é™¤è¯¥åˆ†ç»„ï¼Ÿï¼ˆåŸºé‡‘ä¸ä¼šè¢«åˆ é™¤ï¼Œåªæ˜¯ç§»å‡ºåˆ†ç»„ï¼‰')) return;
            const data = loadStrategyGroups();
            const grp = data.groups.find(g => g.id === groupId);
            if (grp) {
                // è§£é™¤æ˜ å°„
                for (const code of grp.fund_codes) {
                    delete data.fund_group_map[code];
                }
                data.groups = data.groups.filter(g => g.id !== groupId);
            }
            saveStrategyGroups(data);
            loadStrategyPanel();
        }

        function showAssignGroupModal(fundCode) {
            const data = loadStrategyGroups();
            if (!data.overrides) data.overrides = {};
            const currentGroupId = data.fund_group_map[fundCode] || '';
            const fundName = valuations[fundCode]?.fund_name || fundCode;
            const hasOverride = fundCode in data.overrides;
            // v5.4: æå–è‡ªåŠ¨å½’ç±»çš„ç›®æ ‡tag
            const autoTag = fundCode.includes('__') ? fundCode.split('__')[1] : '';

            document.getElementById('assignGroupTitle').textContent = `åˆ†é… ${fundCode} åˆ°åˆ†ç»„`;

            let html = '';

            // v5.4: å¦‚æœæœ‰æ‰‹åŠ¨è¦†ç›–ï¼Œæ˜¾ç¤º"æ¢å¤è‡ªåŠ¨å½’ç±»"é€‰é¡¹
            if (hasOverride && autoTag) {
                html += `<div style="padding:8px 10px;border-bottom:1px solid #dbeafe;cursor:pointer;border-radius:4px;background:#fef3c7;" onclick="resetAutoGroup('${fundCode}')">
                    <span style="font-size:12px;color:#92400e;">ğŸ”„ æ¢å¤è‡ªåŠ¨å½’ç±»ï¼ˆâ†’ ${autoTag}ï¼‰</span>
                </div>`;
            }

            // æ— åˆ†ç»„é€‰é¡¹
            html += `<div style="padding:8px 10px;border-bottom:1px solid #f1f5f9;cursor:pointer;border-radius:4px;${!currentGroupId ? 'background:#eff6ff;' : ''}" onclick="assignFundToGroup('${fundCode}','')">
                <span style="font-size:12px;color:#374151;">ğŸ“‚ ä¸åˆ†ç»„</span>
                ${!currentGroupId ? '<span style="float:right;color:#4f46e5;font-size:11px;">âœ“ å½“å‰</span>' : ''}
            </div>`;

            for (const grp of data.groups) {
                const isCurrent = currentGroupId === grp.id;
                html += `<div style="padding:8px 10px;border-bottom:1px solid #f1f5f9;cursor:pointer;border-radius:4px;${isCurrent ? 'background:#eff6ff;' : ''}" onclick="assignFundToGroup('${fundCode}','${grp.id}')">
                    <span style="font-size:12px;color:#374151;">ğŸ“ ${grp.name}</span>
                    <span style="font-size:11px;color:#9ca3af;margin-left:8px;">${grp.fund_codes.length}åªåŸºé‡‘</span>
                    ${isCurrent ? '<span style="float:right;color:#4f46e5;font-size:11px;">âœ“ å½“å‰</span>' : ''}
                </div>`;
            }

            // å¿«æ·æ–°å»ºåˆ†ç»„
            html += `<div style="padding:10px 10px 4px;"><button class="btn-primary" onclick="closeModal('assignGroupModal');showGroupModal()" style="width:100%;padding:6px;font-size:12px;">â• æ–°å»ºåˆ†ç»„</button></div>`;

            document.getElementById('assignGroupList').innerHTML = html;
            document.getElementById('assignGroupModal').classList.add('show');
        }

        // v5.4: æ¢å¤è‡ªåŠ¨å½’ç±»ï¼ˆåˆ é™¤æ‰‹åŠ¨è¦†ç›–ï¼‰
        function resetAutoGroup(fundCode) {
            const data = loadStrategyGroups();
            if (data.overrides) delete data.overrides[fundCode];
            saveStrategyGroups(data);
            closeModal('assignGroupModal');
            showStatus('å·²æ¢å¤è‡ªåŠ¨å½’ç±»', 'success');
            loadStrategyPanel();
        }

        function assignFundToGroup(fundCode, groupId) {
            const data = loadStrategyGroups();
            if (!data.overrides) data.overrides = {};
            const oldGroupId = data.fund_group_map[fundCode];

            // ä»æ—§åˆ†ç»„ä¸­ç§»é™¤
            if (oldGroupId) {
                const oldGrp = data.groups.find(g => g.id === oldGroupId);
                if (oldGrp) {
                    oldGrp.fund_codes = oldGrp.fund_codes.filter(c => c !== fundCode);
                }
            }

            // æ·»åŠ åˆ°æ–°åˆ†ç»„
            if (groupId) {
                const newGrp = data.groups.find(g => g.id === groupId);
                if (newGrp && !newGrp.fund_codes.includes(fundCode)) {
                    newGrp.fund_codes.push(fundCode);
                }
                data.fund_group_map[fundCode] = groupId;
            } else {
                delete data.fund_group_map[fundCode];
            }

            // v5.4 ä¼˜åŒ–: è®°å½•æ‰‹åŠ¨è¦†ç›–ï¼Œé˜²æ­¢è‡ªåŠ¨åŒæ­¥å†²æ‰ç”¨æˆ·é€‰æ‹©
            data.overrides[fundCode] = groupId || "";

            saveStrategyGroups(data);
            closeModal('assignGroupModal');
            showStatus('åˆ†ç»„å·²æ›´æ–°', 'success');
            loadStrategyPanel();
        }

        // ============ å¯¼å‡ºç­–ç•¥åˆ†ç»„å›¾ç‰‡ï¼ˆå®Œæ•´å¡ç‰‡ï¼‰ ============
        async function exportStrategyGroupImage(groupId) {
            const data = loadStrategyGroups();
            const grp = data.groups.find(g => g.id === groupId);
            if (!grp || grp.fund_codes.length === 0) {
                showStatus('åˆ†ç»„ä¸ºç©ºï¼Œæ— æ³•å¯¼å‡º', 'error');
                return;
            }

            // æ‰¾åˆ°è¯¥åˆ†ç»„åœ¨ DOM ä¸­çš„å®¹å™¨
            const groupEl = document.querySelector(`.strategy-group[data-group-id="${groupId}"]`);
            if (!groupEl) {
                showStatus('è¯·å…ˆåŠ è½½ç­–ç•¥é¢æ¿å†å¯¼å‡º', 'error');
                return;
            }

            showStatus('æ­£åœ¨ç”Ÿæˆå›¾ç‰‡ï¼Œè¯·ç¨å€™...', 'info');

            try {
                // ä¸´æ—¶éšè—ä¸éœ€è¦å¯¼å‡ºçš„æŒ‰é’®ï¼ˆæ“ä½œæŒ‰é’®ã€åˆ é™¤æŒ‰é’®ç­‰ï¼‰
                const btnsToHide = groupEl.querySelectorAll(
                    '.group-actions, .pos-actions, .signal-card-header button, .strategy-info-btn, ' +
                    'td button, .pos-batches button'
                );
                btnsToHide.forEach(el => el.dataset._origDisplay = el.style.display);
                btnsToHide.forEach(el => el.style.display = 'none');

                // ä¸´æ—¶æŠ˜å ç­–ç•¥è¯¦æƒ…æ¡†ï¼ˆé€šå¸¸æ˜¯éšè—çš„ï¼‰
                const infoBoxes = groupEl.querySelectorAll('.strategy-info-box');
                const infoStates = [];
                infoBoxes.forEach(el => {
                    infoStates.push(el.style.display);
                    if (!el.style.display || el.style.display === 'none') {
                        // already hidden, keep it
                    }
                });

                // ä½¿ç”¨ html2canvas æˆªå›¾
                const canvas = await html2canvas(groupEl, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    logging: false,
                    // å¢å¤§å®½åº¦ä»¥ç¡®ä¿ä¸è¢«æˆªæ–­
                    windowWidth: Math.max(groupEl.scrollWidth, 960),
                });

                // æ¢å¤éšè—çš„æŒ‰é’®
                btnsToHide.forEach(el => {
                    el.style.display = el.dataset._origDisplay || '';
                    delete el.dataset._origDisplay;
                });

                // ä¸‹è½½
                const timeStr = new Date().toLocaleString('zh-CN', {
                    month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'
                });
                const link = document.createElement('a');
                link.download = `${grp.name}_${timeStr.replace(/[\/\s:]/g, '')}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                showStatus('åˆ†ç»„å›¾ç‰‡å·²å¯¼å‡º', 'success');
            } catch (e) {
                showStatus('å¯¼å‡ºå¤±è´¥: ' + e.message, 'error');
                // ç¡®ä¿æŒ‰é’®æ¢å¤
                const btnsToRestore = groupEl.querySelectorAll('[data-_orig-display]');
                btnsToRestore.forEach(el => {
                    el.style.display = el.dataset._origDisplay || '';
                    delete el.dataset._origDisplay;
                });
            }
        }

        // ============ å¯¼å‡ºå›¾ç‰‡ï¼ˆå®æ—¶ä¼°å€¼æ¿å—ï¼‰ ============
        async function exportSectorImage(sectorIndex) {
            const sector = state.sectors[sectorIndex];
            if (!sector || sector.funds.length === 0) {
                showStatus('æ¿å—ä¸ºç©ºï¼Œæ— æ³•å¯¼å‡º', 'error');
                return;
            }

            const sortedFunds = [...sector.funds]
                .filter(f => {
                    const v = valuations[f.code];
                    if (!v) return false;
                    // å‡€å€¼æ¥æºï¼ˆæœ‰âœ“æ ‡è®°ï¼‰æ— è§†ç½®ä¿¡åº¦åˆ¤æ–­ï¼Œç›´æ¥è¾“å‡º
                    if (v._source === 'nav') return true;
                    // ç›˜ä¸­ä¼°å€¼ï¼šç½®ä¿¡åº¦ä½äº60%ä¸è¾“å‡º
                    return v.confidence >= 0.60;
                })
                .sort((a, b) => {
                const valA = valuations[a.code];
                const valB = valuations[b.code];
                return (valB?.estimation_change ?? -999) - (valA?.estimation_change ?? -999);
            });

            if (sortedFunds.length === 0) {
                showStatus('æ²¡æœ‰ç½®ä¿¡åº¦è¶³å¤Ÿçš„åŸºé‡‘å¯å¯¼å‡º', 'error');
                return;
            }

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            const P = 16, rowH = 26, headH = 36, thH = 22, W = 480;
            const H = headH + thH + sortedFunds.length * rowH + P;

            // åˆ—ä½ç½®ï¼ˆå³å¯¹é½åŸºå‡†ç‚¹ï¼‰
            const colCodeL = P;
            const colNameL = P + 58;
            const colChangeR = W - P - 75;   // ä¼°å€¼æ¶¨å¹…å³è¾¹ç•Œ
            const col5dayR = W - P;           // è¿‘5æ—¥å³è¾¹ç•Œ

            canvas.width = W * 2;
            canvas.height = H * 2;
            ctx.scale(2, 2);

            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, W, H);

            // æ ‡é¢˜
            ctx.fillStyle = '#1e293b';
            ctx.font = 'bold 14px -apple-system, BlinkMacSystemFont, sans-serif';
            ctx.fillText(sector.name, P, P + 14);

            ctx.fillStyle = '#9ca3af';
            ctx.font = '11px -apple-system, BlinkMacSystemFont, sans-serif';
            const timeStr = new Date().toLocaleString('zh-CN', {month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'});
            ctx.fillText(timeStr, W - P - ctx.measureText(timeStr).width, P + 14);

            // è¡¨å¤´
            ctx.fillStyle = '#f1f5f9';
            ctx.fillRect(0, headH, W, thH);
            ctx.fillStyle = '#64748b';
            ctx.font = '10px -apple-system, BlinkMacSystemFont, sans-serif';
            ctx.fillText('ä»£ç ', colCodeL, headH + 15);
            ctx.fillText('åŸºé‡‘åç§°', colNameL, headH + 15);
            let tw;
            tw = ctx.measureText('ä¼°å€¼æ¶¨å¹…').width;
            ctx.fillText('ä¼°å€¼æ¶¨å¹…', colChangeR - tw, headH + 15);
            tw = ctx.measureText('è¿‘5æ—¥').width;
            ctx.fillText('è¿‘5æ—¥', col5dayR - tw, headH + 15);

            // æ•°æ®è¡Œ
            sortedFunds.forEach((fund, i) => {
                const y = headH + thH + i * rowH;
                const val = valuations[fund.code];
                const textY = y + 17;

                if (i % 2 === 1) { ctx.fillStyle = '#f8fafc'; ctx.fillRect(0, y, W, rowH); }

                // ä»£ç 
                ctx.fillStyle = '#6366f1';
                ctx.font = '11px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.fillText(fund.code, colCodeL, textY);

                // åç§°
                ctx.fillStyle = '#334155';
                ctx.font = '11px -apple-system, BlinkMacSystemFont, sans-serif';
                let name = fund.alias || val?.fund_name || '';
                if (name.length > 14) name = name.slice(0, 14) + '...';
                ctx.fillText(name, colNameL, textY);

                // ä¼°å€¼æ¶¨å¹…ï¼ˆå³å¯¹é½ï¼‰
                let chgTxt = '--', chgClr = '#64748b';
                if (val?.estimation_change != null) {
                    const c = val.estimation_change;
                    chgTxt = (c >= 0 ? '+' : '') + c.toFixed(2) + '%';
                    chgClr = c > 0 ? '#ef4444' : c < 0 ? '#22c55e' : '#64748b';
                }
                ctx.fillStyle = chgClr;
                ctx.font = 'bold 12px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.fillText(chgTxt, colChangeR - ctx.measureText(chgTxt).width, textY);

                // å‡€å€¼æ—¥æœŸæ ‡æ³¨ï¼ˆéä»Šå¤©çš„å†å²å‡€å€¼æ—¶æ˜¾ç¤ºæ—¥æœŸï¼‰
                if (val?._source === 'nav' && val?._nav_date) {
                    const todayCheck = new Date().toISOString().slice(0, 10);
                    if (val._nav_date !== todayCheck) {
                        const md = val._nav_date.slice(5).replace(/^0/, '').replace(/-0?/, '/');
                        ctx.fillStyle = '#f59e0b';
                        ctx.font = '9px -apple-system, BlinkMacSystemFont, sans-serif';
                        ctx.fillText(md, colChangeR + 2, textY);
                    }
                }

                // è¿‘5æ—¥ï¼ˆå³å¯¹é½ï¼‰
                let wTxt = '--', wClr = '#64748b';
                if (val?.week_change != null) {
                    const w = val.week_change;
                    wTxt = (w >= 0 ? '+' : '') + w.toFixed(2) + '%';
                    wClr = w > 0 ? '#ef4444' : w < 0 ? '#22c55e' : '#64748b';
                }
                ctx.fillStyle = wClr;
                ctx.font = 'bold 12px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.fillText(wTxt, col5dayR - ctx.measureText(wTxt).width, textY);
            });

            const link = document.createElement('a');
            link.download = `${sector.name}_${timeStr.replace(/[\/\s:]/g, '')}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            showStatus('å›¾ç‰‡å·²å¯¼å‡º', 'success');
        }

        async function exportAllSectorImages() {
            if (!state.sectors || state.sectors.length === 0) {
                showStatus('æ²¡æœ‰æ¿å—å¯å¯¼å‡º', 'error');
                return;
            }
            let exported = 0;
            for (let i = 0; i < state.sectors.length; i++) {
                const sector = state.sectors[i];
                if (sector.funds.length === 0) continue;
                // å¤ç”¨å•æ¿å—å¯¼å‡ºï¼ŒåŠ å»¶è¿Ÿé¿å…æµè§ˆå™¨åä¸‹è½½
                await exportSectorImage(i);
                exported++;
                if (i < state.sectors.length - 1) {
                    await new Promise(r => setTimeout(r, 500));
                }
            }
            if (exported > 0) {
                showStatus(`å·²å¯¼å‡º ${exported} ä¸ªæ¿å—å›¾ç‰‡`, 'success');
            } else {
                showStatus('æ²¡æœ‰å¯å¯¼å‡ºçš„æ¿å—', 'error');
            }
        }

        // ============ åˆå§‹åŒ– ============
        window.onload = async () => {
            await loadState();
            if (state.sectors.some(s => s.funds.length > 0)) {
                await refreshAll();
            }
            startAutoRefresh();
        };

        // å›è½¦/ESC é”®å¤„ç†
        document.addEventListener('keydown', e => {
            if (e.key === 'Enter' && document.getElementById('addSectorModal').classList.contains('show')) {
                addSector();
            }
            if (e.key === 'Enter' && document.getElementById('etfLinkModal').classList.contains('show')) {
                saveEtfLink();
            }
            if (e.key === 'Enter' && document.getElementById('buyModal').classList.contains('show')) {
                submitBuy();
            }
            if (e.key === 'Enter' && document.getElementById('sellModal').classList.contains('show')) {
                submitSell();
            }
            if (e.key === 'Enter' && document.getElementById('groupModal').classList.contains('show')) {
                saveGroup();
            }
            if (e.key === 'Escape') {
                closeModal('addSectorModal');
                closeModal('etfLinkModal');
                closeModal('navHistoryModal');
                closeModal('buyModal');
                closeModal('sellModal');
                closeModal('groupModal');
                closeModal('assignGroupModal');
                closeModal('volSensModal');
            }
        });

        // ============ æ³¢åŠ¨ç‡çµæ•åº¦è°ƒæ•´ ============
        async function showVolSensitivityModal(fundCode) {
            document.getElementById('volSensFundCode').value = fundCode;
            const realCode = fundCode.includes('__') ? fundCode.split('__')[0] : fundCode;
            const name = valuations[realCode]?.fund_name || realCode;
            document.getElementById('volSensTitle').textContent = `è°ƒæ•´çµæ•åº¦ Â· ${name}`;

            // åŠ è½½å½“å‰ä¿¡æ¯
            const infoEl = document.getElementById('volSensInfo');
            infoEl.innerHTML = '<span class="loading"></span>åŠ è½½ä¸­...';
            document.getElementById('volSensModal').classList.add('show');

            try {
                const res = await fetch(`${API_BASE}/v1/position/${encodeURIComponent(fundCode)}/vol-sensitivity`);
                const data = await res.json();
                const slider = document.getElementById('volSensSlider');
                const display = document.getElementById('volSensDisplay');
                slider.value = data.effective;
                display.textContent = data.effective.toFixed(2);

                const sourceMap = { manual: 'æ‰‹åŠ¨è®¾ç½®', auto: 'è‡ªåŠ¨æ ¡å‡†', default: 'é»˜è®¤å€¼' };
                let infoHtml = `<div>å½“å‰ç”Ÿæ•ˆ: <b>${data.effective.toFixed(2)}Ã—</b> (${sourceMap[data.source] || data.source})</div>`;
                if (data.auto_cached != null) {
                    infoHtml += `<div>è‡ªåŠ¨æ ¡å‡†å€¼: ${data.auto_cached.toFixed(2)}Ã— (${data.auto_cached_at || ''})</div>`;
                }
                if (data.manual != null) {
                    infoHtml += `<div>æ‰‹åŠ¨è®¾ç½®å€¼: ${data.manual.toFixed(2)}Ã—</div>`;
                }
                infoHtml += `<div style="margin-top:4px;color:#9ca3af;font-size:10px;">
                    çµæ•åº¦ < 1.0 = é˜ˆå€¼æ›´çµæ•(æ›´æ˜“è§¦å‘ä¹°å–) Â· > 1.0 = é˜ˆå€¼æ›´å®½(æ›´ä¸æ˜“è§¦å‘)
                </div>`;
                infoEl.innerHTML = infoHtml;
            } catch (e) {
                infoEl.innerHTML = `<span style="color:#ef4444;">åŠ è½½å¤±è´¥: ${e.message}</span>`;
            }
        }

        async function saveVolSensitivity() {
            const fundCode = document.getElementById('volSensFundCode').value;
            const value = parseFloat(document.getElementById('volSensSlider').value);
            try {
                const res = await fetch(`${API_BASE}/v1/position/${encodeURIComponent(fundCode)}/vol-sensitivity`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sensitivity: value })
                });
                if (!res.ok) throw new Error('è®¾ç½®å¤±è´¥');
                showStatus(`çµæ•åº¦å·²è®¾ä¸º ${value.toFixed(2)}Ã—`, 'success');
                closeModal('volSensModal');
                loadStrategyPanel();
            } catch (e) {
                showStatus('è®¾ç½®å¤±è´¥: ' + e.message, 'error');
            }
        }

        async function clearVolSensitivity() {
            const fundCode = document.getElementById('volSensFundCode').value;
            try {
                const res = await fetch(`${API_BASE}/v1/position/${encodeURIComponent(fundCode)}/vol-sensitivity`, {
                    method: 'DELETE'
                });
                if (!res.ok) throw new Error('æ¸…é™¤å¤±è´¥');
                showStatus('å·²æ¢å¤è‡ªåŠ¨æ ¡å‡†', 'success');
                closeModal('volSensModal');
                loadStrategyPanel();
            } catch (e) {
                showStatus('æ“ä½œå¤±è´¥: ' + e.message, 'error');
            }
        }

        async function recalibrateVolSensitivity() {
            const fundCode = document.getElementById('volSensFundCode').value;
            try {
                const btn = event.target;
                btn.textContent = 'æ ¡å‡†ä¸­...';
                btn.disabled = true;
                const res = await fetch(`${API_BASE}/v1/position/${encodeURIComponent(fundCode)}/vol-sensitivity/calibrate`, {
                    method: 'POST'
                });
                if (!res.ok) throw new Error('æ ¡å‡†å¤±è´¥');
                const data = await res.json();
                showStatus(`é‡æ–°æ ¡å‡†å®Œæˆ: ${data.effective.toFixed(2)}Ã—`, 'success');
                // åˆ·æ–°å¼¹çª—ä¿¡æ¯
                showVolSensitivityModal(fundCode);
            } catch (e) {
                showStatus('æ ¡å‡†å¤±è´¥: ' + e.message, 'error');
            }
        }
    </script>
</body>
</html>